import React, { useState, useEffect, useMemo, useRef } from 'react';
import {
  Shield, Calendar, Users, LayoutDashboard,
  Settings, LogOut, Plus, Search, ChevronRight, ChevronLeft,
  MapPin, Phone, Mail, Clock, AlertTriangle, CheckCircle,
  FileText, Activity, Menu, X as XIcon, User, Trash2, Edit2,
  List as ListIcon, Grid as GridIcon, MinusCircle, GraduationCap,
  Baby, UserCheck, MessageSquare, Award, TrendingUp, Send,
  Info, TrendingDown, ArrowUpRight, ArrowDownRight, Wallet,
  Save, Building, UserCog, ClipboardList, Package, Trophy, Map as MapIcon,
  Printer, CreditCard, Coins, Repeat, Lock, Eye, ChevronDown, ChevronUp,
  Instagram, Facebook, MessageCircle, Megaphone, Sun, Moon
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import {
  getAuth, signInWithCustomToken, signInAnonymously,
  onAuthStateChanged, signOut, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, updateProfile
} from 'firebase/auth';
import {
  getFirestore, collection, doc, setDoc,
  onSnapshot, addDoc, updateDoc, deleteDoc,
  serverTimestamp, query, orderBy, where, Timestamp
} from 'firebase/firestore';

// --- Icon Alias ---
const Horse = Shield; // Alias Shield as Horse to avoid import conflicts

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'stable-os-v1';

// ==========================================
// 2. DOMAIN LOGIC
// ==========================================

export const safeDate = (val) => {
  if (!val) return new Date();
  if (val.toDate) return val.toDate();
  if (typeof val === 'string' || typeof val === 'number') {
    return new Date(val);
  }
  return val instanceof Date ? val : new Date();
};

export const getParticipants = (lesson) => {
  if (Array.isArray(lesson.attendees) && lesson.attendees.length > 0) {
    return lesson.attendees;
  }
  if (lesson.student || lesson.horse) {
    return [{ student: lesson.student || 'Unknown', horse: lesson.horse || 'Unknown' }];
  }
  return [];
};

export const getLessonBadgeType = (type) => {
  switch (type) {
    case 'Private': return 'primary';
    case 'Group': return 'success';
    case 'Clinic': return 'purple';
    case 'Competition': return 'gold';
    case 'Arena Rent':
    case 'Arena Rental':
      return 'gray';
    default:
      return 'neutral';
  }
};

export const getSmartLessonColor = (lesson) => {
  const text = `${lesson.title} ${lesson.focus || ''}`.toLowerCase();

  if (text.includes('jump') || text.includes('pole')) return 'warning';
  if (text.includes('flat') || text.includes('dressage')) return 'blue';

  return getLessonBadgeType(lesson.type);
};

// ==========================================
// 3. UI COMPONENTS
// ==========================================

const DatabaseIcon = ({className}) => (<svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s 9-1.34 9-3V5"></path></svg>);

const Card = ({ children, className = "" }) => (
  <div className={`bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden transition-colors duration-200 ${className}`}>
    {children}
  </div>
);

const Badge = ({ children, type = "primary" }) => {
  const styles = {
    primary: "bg-indigo-50 text-indigo-700 border-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800",
    success: "bg-emerald-50 text-emerald-700 border-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800",
    warning: "bg-orange-50 text-orange-700 border-orange-100 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800",
    danger: "bg-rose-50 text-rose-700 border-rose-100 dark:bg-rose-900/30 dark:text-rose-300 dark:border-rose-800",
    neutral: "bg-gray-50 text-gray-600 border-gray-100 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600",
    purple: "bg-purple-50 text-purple-700 border-purple-100 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800",
    gold: "bg-amber-50 text-amber-700 border-amber-100 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800",
    blue: "bg-sky-50 text-sky-700 border-sky-100 dark:bg-sky-900/30 dark:text-sky-300 dark:border-sky-800",
    gray: "bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600",
  };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium border ${styles[type] || styles.neutral}`}>
      {children}
    </span>
  );
};

const Button = ({ children, onClick, variant = "primary", className = "", icon: Icon, disabled = false, type = "button", size = "md" }) => {
  const baseStyle = "inline-flex items-center justify-center rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";
  const sizeStyles = {
      sm: "px-3 py-1.5 text-xs",
      md: "px-4 py-2 text-sm"
  };
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 dark:bg-indigo-500 dark:hover:bg-indigo-600",
    secondary: "bg-white dark:bg-slate-700 text-gray-700 dark:text-slate-200 border border-gray-300 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-600 focus:ring-indigo-500",
    danger: "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500",
    ghost: "text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 focus:ring-gray-500",
  };
  return (
    <button
      type={type}
      onClick={onClick}
      className={`${baseStyle} ${sizeStyles[size]} ${variants[variant]} ${className}`}
      disabled={disabled}
    >
      {Icon && <Icon className={`mr-2 ${size === 'sm' ? 'w-3 h-3' : 'w-4 h-4'}`} />}
      {children}
    </button>
  );
};

const Input = ({ label, className = "", ...props }) => (
  <div className={`mb-4 ${className}`}>
    {label && <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">{label}</label>}
    <input
      className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
      {...props}
    />
  </div>
);

const Select = ({ label, children, className = "", ...props }) => (
  <div className={`mb-4 ${className}`}>
    {label && <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">{label}</label>}
    <select
      className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
      {...props}
    >
      {children}
    </select>
  </div>
);

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto transition-colors duration-200">
        <div className="flex items-center justify-between p-4 border-b dark:border-slate-700">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white">{title}</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <XIcon className="w-5 h-5" />
          </button>
        </div>
        <div className="p-4">{children}</div>
      </div>
    </div>
  );
};

// --- App Layout Component (Unified Sidebar) ---
const AppLayout = ({ title = "StableOS", navItems, activeTab, onTabChange, bottomContent, children, darkMode, toggleTheme }) => {
  return (
    <div className="flex h-screen bg-slate-50 dark:bg-slate-900 font-sans overflow-hidden transition-colors duration-200">
      {/* Sidebar */}
      <aside className="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col flex-shrink-0 z-20 transition-colors duration-200">
        {/* Logo Area */}
        <div className="h-16 flex items-center px-6 border-b border-slate-100 dark:border-slate-700">
           <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-sm">
             <Shield className="w-5 h-5" />
           </div>
           <span className="font-bold text-xl text-slate-900 dark:text-white tracking-tight">{title}</span>
        </div>

        {/* Navigation */}
        <nav className="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
          {navItems.map(item => (
            <button
              key={item.id}
              onClick={() => onTabChange(item.id)}
              className={`w-full flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 group ${
                activeTab === item.id
                  ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 shadow-sm'
                  : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200'
              }`}
            >
              <item.icon 
                className={`w-5 h-5 mr-3 transition-colors ${
                  activeTab === item.id ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300'
                }`} 
              />
              {item.label}
            </button>
          ))}
        </nav>

        {/* Bottom Area */}
        {bottomContent && (
          <div className="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 transition-colors duration-200">
             {bottomContent}
          </div>
        )}
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col min-w-0 h-screen overflow-hidden bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
        {/* Header Bar */}
        <header className="h-16 flex items-center justify-between px-8 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 transition-colors duration-200 shrink-0">
            <h2 className="text-xl font-bold text-slate-800 dark:text-white capitalize">{activeTab}</h2>
            
            <div className="flex items-center gap-4">
              {/* Theme Switcher Button */}
              <button 
                onClick={toggleTheme}
                className="p-2 text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 rounded-full transition-colors"
                title={darkMode ? "Switch to Light Mode" : "Switch to Dark Mode"}
              >
                {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
              </button>
            </div>
        </header>

        <div className="flex-1 overflow-y-auto p-8 relative">
          {children}
        </div>
      </main>
    </div>
  );
};

// --- Sidebar Footer Extracted Component ---
const SidebarFooter = ({ role, currentUserProfile, students = [], parents = [], staff = [], onSwitchRole, onLogout }) => (
    <div className="space-y-4">
      {/* Role Switcher in Sidebar Footer */}
      <div className="px-1">
        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Switch Perspective</p>
        <select 
            className="w-full text-sm p-2.5 border border-slate-200 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer"
            value={role === 'Administrator' ? "" : `${role}:${currentUserProfile?.id || ''}`}
            onChange={(e) => {
                const val = e.target.value;
                if (!val) onSwitchRole('Administrator', null);
                else {
                    const [newRole, id] = val.split(':');
                    if (newRole === 'Student') onSwitchRole('Student', students.find(s => s.id === id));
                    else if (newRole === 'Parent') onSwitchRole('Parent', parents.find(p => p.id === id));
                    else if (newRole === 'Staff') onSwitchRole('Staff', staff.find(s => s.id === id));
                }
            }}
        >
            <option value="">Administrator</option>
            <optgroup label="Students">{students.map(s => <option key={s.id} value={`Student:${s.id}`}>{s.name}</option>)}</optgroup>
            <optgroup label="Parents">{parents.map(p => <option key={p.id} value={`Parent:${p.id}`}>{p.name}</option>)}</optgroup>
            <optgroup label="Staff">{staff.map(s => <option key={s.id} value={`Staff:${s.id}`}>{s.name}</option>)}</optgroup>
        </select>
      </div>

      <button 
        onClick={onLogout}
        className="w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors"
      >
        <LogOut className="w-5 h-5 mr-3" />
        Sign Out
      </button>
    </div>
);

// --- Booking Modal Helper ---
const BookingRequestModal = ({ isOpen, onClose, onSubmit, students, defaultStudent }) => {
    const [formData, setFormData] = useState({ date: '', time: '09:00', timeEnd: '', type: 'Private', student: defaultStudent || '', notes: '' });
    
    useEffect(() => {
        if(isOpen && defaultStudent) {
            setFormData(prev => ({...prev, student: defaultStudent}));
        }
    }, [isOpen, defaultStudent]);
    if (!isOpen) return null;

    const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
        onClose();
        setFormData({ date: '', time: '09:00', timeEnd: '', type: 'Private', student: defaultStudent || '', notes: '' });
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Request Booking">
            <div className="mb-4 bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-blue-800 dark:text-blue-200 text-sm flex items-start">
                <Info className="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" />
                <p>This will submit a request to the stable. A staff member will review and confirm your lesson time.</p>
            </div>
            <form onSubmit={handleSubmit}>
                {students && students.length > 0 && (
                    <Select label="Student" value={formData.student} onChange={e => setFormData({...formData, student: e.target.value})}>
                        {students.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </Select>
                )}
                
                <Input type="date" label="Preferred Date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} required />
                
                <div className="grid grid-cols-2 gap-4">
                    <Input type="time" label="Start Time / From" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} required />
                    <Input type="time" label="End Time / To (Optional)" value={formData.timeEnd} onChange={e => setFormData({...formData, timeEnd: e.target.value})} />
                </div>
                
                <Select label="Lesson Type" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}>
                    <option>Private</option>
                    <option>Group</option>
                    <option>Clinic</option>
                </Select>
                <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Notes / Instructor Preference</label>
                    <textarea 
                        className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                        rows="3"
                        value={formData.notes}
                        onChange={e => setFormData({...formData, notes: e.target.value})}
                        placeholder="e.g. Prefer jumping lesson with Sarah"
                    />
                </div>
                <div className="flex justify-end pt-2">
                    <Button type="submit" icon={Send}>Submit Request</Button>
                </div>
            </form>
        </Modal>
    );
};

// --- New Component: AnnouncementWidget ---
const AnnouncementWidget = ({ announcements }) => {
    // Sort by date desc
    const recent = [...(announcements || [])]
        .sort((a,b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);

    if (recent.length === 0) return null;

    return (
        <div className="mb-6 space-y-4">
             {recent.map(a => (
                 <div key={a.id} className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-4 text-white shadow-md relative overflow-hidden">
                     <div className="relative z-10">
                        <div className="flex justify-between items-start mb-1">
                             <h3 className="font-bold text-lg flex items-center">
                                 <Megaphone className="w-5 h-5 mr-2" />
                                 {a.title}
                             </h3>
                             <span className="text-xs font-medium bg-white/20 px-2 py-1 rounded">
                                 {new Date(a.date).toLocaleDateString()}
                             </span>
                        </div>
                        <p className="opacity-90 text-sm whitespace-pre-wrap">{a.content}</p>
                        <p className="text-xs mt-2 opacity-75 font-medium">Posted by: {a.author}</p>
                     </div>
                     {/* Decorative circles */}
                     <div className="absolute -right-4 -bottom-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                     <div className="absolute -left-4 -top-10 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                 </div>
             ))}
        </div>
    );
};

// --- New Component: AnnouncementsModule ---
const AnnouncementsModule = ({ announcements, onAdd, onDelete, currentUser }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({ title: '', content: '' });

    const handleSubmit = (e) => {
        e.preventDefault();
        onAdd({
            ...formData,
            date: new Date().toISOString(),
            author: currentUser.name,
            role: currentUser.role || 'Admin'
        });
        setIsModalOpen(false);
        setFormData({ title: '', content: '' });
    };

    const sorted = [...(announcements || [])].sort((a,b) => new Date(b.date) - new Date(a.date));

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Announcements</h2>
                <Button onClick={() => setIsModalOpen(true)} icon={Plus}>New Announcement</Button>
            </div>

            <div className="space-y-4">
                {sorted.map(item => (
                    <Card key={item.id} className="p-6 relative group">
                        <div className="flex justify-between items-start">
                            <div>
                                <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">{item.title}</h3>
                                <p className="text-gray-600 dark:text-slate-300 whitespace-pre-wrap mb-4">{item.content}</p>
                                <div className="flex items-center text-sm text-gray-400">
                                    <span className="mr-4">Posted: {new Date(item.date).toLocaleDateString()}</span>
                                    <span>By: {item.author} ({item.role})</span>
                                </div>
                            </div>
                            <button 
                                onClick={() => onDelete(item.id)}
                                className="text-gray-400 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity"
                            >
                                <Trash2 className="w-5 h-5" />
                            </button>
                        </div>
                    </Card>
                ))}
                {sorted.length === 0 && (
                    <div className="text-center py-12 text-gray-500 dark:text-slate-400 bg-gray-50 dark:bg-slate-800 rounded-xl border border-dashed border-gray-300 dark:border-slate-700">
                        No announcements posted yet.
                    </div>
                )}
            </div>

            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Post Announcement">
                <form onSubmit={handleSubmit}>
                    <Input label="Title" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} required />
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Content</label>
                        <textarea
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            rows="4"
                            value={formData.content}
                            onChange={e => setFormData({...formData, content: e.target.value})}
                            required
                        />
                    </div>
                    <div className="flex justify-end pt-2">
                        <Button type="submit" icon={Megaphone}>Post</Button>
                    </div>
                </form>
            </Modal>
        </div>
    );
};

// --- View Components (Student, Parent, Staff) ---

const StudentView = ({ student, lessons, horses, settings, onBookLesson, announcements }) => {
  const [isBookingOpen, setIsBookingOpen] = useState(false);
  
  if (!student) return <div className="p-8 text-center text-gray-500">Loading student profile...</div>;

  // Adjusted filter: Includes future lessons/today AND Competitions (even if not assigned)
  const upcomingLessons = lessons.filter(l => {
      const isMyLesson = getParticipants(l).some(p => p.student === student.name);
      const isCompetition = l.type === 'Competition';
      const d = safeDate(l.date);
      const now = new Date();
      // Use logic to keep lessons visible for the whole day
      const isRelevantTime = d > now || d.toDateString() === now.toDateString();
      
      return isRelevantTime && (isMyLesson || isCompetition);
  }).sort((a,b) => safeDate(a.date) - safeDate(b.date)).slice(0, 5);
 
  const getHorseStatus = (lesson) => {
      const participant = getParticipants(lesson).find(p => p.student === student.name);
      return participant?.horse || 'TBD (Assigned day-of)';
  };

  // UX Polish: Countdown Calculation
  const getCountdown = (date) => {
      const now = new Date();
      now.setHours(0,0,0,0);
      const lessonDate = safeDate(date);
      lessonDate.setHours(0,0,0,0);
      
      const diffTime = lessonDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today!';
      if (diffDays === 1) return 'Tomorrow';
      if (diffDays > 1 && diffDays < 14) return `In ${diffDays} days`;
      return null;
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Welcome back, {student.name.split(' ')[0]}! üê¥</h1>
          <p className="text-gray-500 dark:text-slate-400">Student Portal</p>
        </div>
      </div>
      
      {/* Announcements */}
      <AnnouncementWidget announcements={announcements} />

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Card className="p-6 bg-gradient-to-br from-indigo-500 to-purple-600 text-white border-none relative overflow-hidden">
          <div className="flex justify-between items-start mb-4 relative z-10">
              <h3 className="text-lg font-medium opacity-90 flex items-center"><Calendar className="w-5 h-5 mr-2" /> Next Lesson</h3>
              {upcomingLessons.length > 0 && getCountdown(upcomingLessons[0].date) && (
                  <span className={`bg-white/20 backdrop-blur-md border border-white/20 px-2 py-0.5 rounded text-xs font-bold ${upcomingLessons[0].status !== 'Cancelled' ? 'animate-pulse' : ''}`}>
                      {getCountdown(upcomingLessons[0].date)}
                  </span>
              )}
          </div>
          
          {upcomingLessons.length > 0 ? (
            <div className="relative z-10">
              <p className={`text-3xl font-bold mb-1 ${upcomingLessons[0].status === 'Cancelled' ? 'line-through decoration-white/50 opacity-75' : ''}`}>{safeDate(upcomingLessons[0].date).toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'})}</p>
              <p className="text-xl opacity-90 mb-4">
                  {upcomingLessons[0].time || safeDate(upcomingLessons[0].date).toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'})}
                  {upcomingLessons[0].timeEnd ? ` - ${upcomingLessons[0].timeEnd}` : ''}
              </p>
              
              <div className={`space-y-3 bg-white/10 rounded-lg p-3 backdrop-blur-sm ${upcomingLessons[0].status === 'Cancelled' ? 'opacity-70' : ''}`}>
                  <div className="flex items-start text-sm">
                    <Horse className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                    <div>
                        <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">Horse</span>
                        {getHorseStatus(upcomingLessons[0])}
                    </div>
                  </div>
                  <div className="flex items-start text-sm">
                    <MapIcon className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                    <div>
                        <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">Location</span>
                        {upcomingLessons[0].location || 'Main Arena'}
                    </div>
                  </div>
                  {upcomingLessons[0].focus && (
                      <div className="flex items-start text-sm border-t border-white/20 pt-2 mt-2">
                        <Activity className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                        <div>
                            <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">Goal / Focus</span>
                            {upcomingLessons[0].focus}
                        </div>
                      </div>
                  )}
                  {upcomingLessons[0].equipment && (
                      <div className="flex items-start text-sm">
                        <Package className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                        <div>
                            <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">What to Bring</span>
                            {upcomingLessons[0].equipment}
                        </div>
                      </div>
                  )}
              </div>

              {upcomingLessons[0].status === 'Pending' && <div className="mt-3 inline-block bg-white/20 px-2 py-1 rounded text-xs font-bold">Pending Confirmation</div>}
              {upcomingLessons[0].status === 'Cancelled' && <div className="mt-3 inline-block bg-red-500 text-white px-2 py-1 rounded text-xs font-bold shadow-lg">CANCELLED</div>}
            </div>
          ) : (
            <div className="py-8 text-center opacity-80 relative z-10">No upcoming lessons scheduled.</div>
          )}
        </Card>

        <Card className="p-6">
          <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center"><Award className="w-5 h-5 mr-2 text-yellow-500" /> Achievements</h3>
          <div className="flex flex-wrap gap-2 mb-6">
            {student.achievements?.map((ach, i) => (
              <span key={i} className="px-2 py-1 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs rounded border border-yellow-100 dark:border-yellow-800 flex items-center">
                <Award className="w-3 h-3 mr-1" /> {ach}
              </span>
            ))}
            {(!student.achievements || student.achievements.length === 0) && <span className="text-xs text-gray-400">No achievements yet. Keep riding!</span>}
          </div>
          
          <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center"><TrendingUp className="w-5 h-5 mr-2 text-indigo-500" /> Recent Progress</h3>
          <div className="space-y-3">
             {student.development?.slice(0, 3).map((note, i) => (
                <div key={i} className="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg border border-gray-100 dark:border-slate-600">
                   <div className="text-xs text-gray-400 mb-1">{safeDate(note.date).toLocaleDateString()}</div>
                   <p className="text-sm text-gray-700 dark:text-gray-300 italic">"{note.text}"</p>
                </div>
             ))}
             {(!student.development || student.development.length === 0) && <span className="text-xs text-gray-400">No progress notes recorded yet.</span>}
          </div>
        </Card>
      </div>

      <div className="flex justify-between items-center pt-4">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white">Your Upcoming Schedule</h3>
        {settings.studentSelfBooking && student.type === 'Adult' && <Button onClick={() => setIsBookingOpen(true)} icon={Plus}>Booking Request</Button>}
      </div>
      
      <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden">
        {upcomingLessons.map(lesson => (
          <div key={lesson.id} className={`p-4 border-b border-gray-100 dark:border-slate-700 last:border-0 flex items-center justify-between ${lesson.status === 'Cancelled' ? 'bg-gray-50 dark:bg-slate-700' : ''}`}>
            <div className={lesson.status === 'Cancelled' ? 'opacity-60' : ''}>
              <p className={`font-semibold text-gray-900 dark:text-white ${lesson.status === 'Cancelled' ? 'line-through decoration-gray-400' : ''}`}>{lesson.title}</p>
              <div className="flex items-center text-sm text-gray-500 dark:text-gray-400 mt-1">
                  <span className={lesson.status === 'Cancelled' ? 'line-through' : ''}>
                      {safeDate(lesson.date).toLocaleDateString('en-GB')} {lesson.time || safeDate(lesson.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                      {lesson.timeEnd ? ` - ${lesson.timeEnd}` : ''}
                  </span>
                  {lesson.focus && <span className="ml-2 pl-2 border-l border-gray-300 dark:border-slate-600 italic text-gray-400">Focus: {lesson.focus}</span>}
              </div>
              <p className="text-xs text-indigo-600 dark:text-indigo-400 flex items-center mt-1 font-medium">
                  <Horse className="w-3 h-3 mr-1" />
                  Horse: {getParticipants(lesson).find(p => p.student === student.name)?.horse || 'TBD'}
              </p>
            </div>
            <div className="flex items-center gap-2">
                {lesson.status === 'Pending' && <span className="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300 text-xs px-2 py-1 rounded-full font-medium">Pending</span>}
                {lesson.status === 'Cancelled' && <span className="bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300 text-xs px-2 py-1 rounded-full font-bold">Cancelled</span>}
                <Badge type={getSmartLessonColor(lesson)}>{lesson.type}</Badge>
            </div>
          </div>
        ))}
        {upcomingLessons.length === 0 && <div className="p-8 text-center text-gray-500">No lessons found.</div>}
      </div>

      <BookingRequestModal 
        isOpen={isBookingOpen} 
        onClose={() => setIsBookingOpen(false)} 
        onSubmit={(data) => {
            onBookLesson({...data, student: student.name});
        }}
        defaultStudent={student.name}
      />
    </div>
  );
};

const ParentView = ({ parent, students, lessons, settings, onBookLesson, announcements }) => {
  const [isBookingOpen, setIsBookingOpen] = useState(false);
  const [selectedChildForBooking, setSelectedChildForBooking] = useState('');
  
  if (!parent) return <div className="p-8 text-center text-gray-500">Loading parent profile...</div>;

  // Filter children belonging to this parent
  const myChildren = students.filter(s => s.parentId === parent.id);
  
  // State for tab switching (default to first child)
  const [activeChildId, setActiveChildId] = useState(null);

  // Initialize active child once children are loaded
  useEffect(() => {
      if (myChildren.length > 0 && !activeChildId) {
          setActiveChildId(myChildren[0].id);
      }
  }, [myChildren, activeChildId]);

  const activeChild = myChildren.find(c => c.id === activeChildId);

  // --- Active Child Data Logic (Mirrors StudentView) ---
  const childLessons = activeChild ? lessons.filter(l => {
      const isMyLesson = getParticipants(l).some(p => p.student === activeChild.name);
      const isCompetition = l.type === 'Competition';
      const d = safeDate(l.date);
      const now = new Date();
      // Show future lessons OR lessons from today
      const isRelevantTime = d > now || d.toDateString() === now.toDateString();
      
      return isRelevantTime && (isMyLesson || isCompetition);
  }).sort((a,b) => safeDate(a.date) - safeDate(b.date)).slice(0, 5) : [];

  const completedLessonsCount = activeChild ? lessons.filter(l => 
      getParticipants(l).some(p => p.student === activeChild.name) && 
      safeDate(l.date) < new Date() && 
      l.status !== 'Cancelled'
  ).length : 0;

  const handleBookingRequest = (childName) => {
      setSelectedChildForBooking(childName);
      setIsBookingOpen(true);
  };

  const getHorseStatus = (lesson) => {
      const participant = getParticipants(lesson).find(p => p.student === activeChild?.name);
      return participant?.horse || 'TBD (Assigned day-of)';
  };

  const getCountdown = (date) => {
      const now = new Date();
      now.setHours(0,0,0,0);
      const lessonDate = safeDate(date);
      lessonDate.setHours(0,0,0,0);
      
      const diffTime = lessonDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today!';
      if (diffDays === 1) return 'Tomorrow';
      if (diffDays > 1 && diffDays < 14) return `In ${diffDays} days`;
      return null;
  };

  return (
    <div className="max-w-5xl mx-auto space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Family Portal</h1>
          <p className="text-gray-500 dark:text-slate-400">Welcome, {parent.name}</p>
        </div>
      </div>
      
      {/* Announcements */}
      <AnnouncementWidget announcements={announcements} />

      {/* Child Tabs */}
      {myChildren.length > 0 ? (
        <div className="flex space-x-1 border-b border-gray-200 dark:border-slate-700 overflow-x-auto pb-1">
            {myChildren.map(child => (
                <button
                    key={child.id}
                    onClick={() => setActiveChildId(child.id)}
                    className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors flex items-center gap-2 ${
                        activeChildId === child.id
                            ? 'bg-indigo-600 text-white shadow-sm'
                            : 'bg-white dark:bg-slate-800 text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200 hover:bg-gray-50 dark:hover:bg-slate-700 border border-transparent'
                    }`}
                >
                    <Baby className={`w-4 h-4 ${activeChildId === child.id ? 'text-indigo-200' : 'text-gray-400'}`} />
                    {child.name}
                </button>
            ))}
        </div>
      ) : (
        <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200 rounded-lg text-sm border border-yellow-100 dark:border-yellow-800 flex items-center">
            <Info className="w-4 h-4 mr-2"/> No students linked to this parent account.
        </div>
      )}

      {/* Active Child Dashboard */}
      {activeChild && (
        <div className="animate-in fade-in slide-in-from-bottom-2 duration-300">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                {/* Next Lesson Card (Mirrored) */}
                <Card className="p-6 bg-gradient-to-br from-indigo-500 to-purple-600 text-white border-none relative overflow-hidden">
                    <div className="flex justify-between items-start mb-4 relative z-10">
                        <h3 className="text-lg font-medium opacity-90 flex items-center"><Calendar className="w-5 h-5 mr-2" /> Next Lesson</h3>
                        {childLessons.length > 0 && getCountdown(childLessons[0].date) && (
                            <span className={`bg-white/20 backdrop-blur-md border border-white/20 px-2 py-0.5 rounded text-xs font-bold ${childLessons[0].status !== 'Cancelled' ? 'animate-pulse' : ''}`}>
                                {getCountdown(childLessons[0].date)}
                            </span>
                        )}
                    </div>
                    
                    {childLessons.length > 0 ? (
                        <div className="relative z-10">
                        <p className={`text-3xl font-bold mb-1 ${childLessons[0].status === 'Cancelled' ? 'line-through decoration-white/50 opacity-75' : ''}`}>{safeDate(childLessons[0].date).toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'})}</p>
                        <p className="text-xl opacity-90 mb-4">
                            {childLessons[0].time || safeDate(childLessons[0].date).toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'})}
                            {childLessons[0].timeEnd ? ` - ${childLessons[0].timeEnd}` : ''}
                        </p>
                        
                        <div className={`space-y-3 bg-white/10 rounded-lg p-3 backdrop-blur-sm ${childLessons[0].status === 'Cancelled' ? 'opacity-70' : ''}`}>
                            <div className="flex items-start text-sm">
                                <Horse className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                                <div>
                                    <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">Horse</span>
                                    {getHorseStatus(childLessons[0])}
                                </div>
                            </div>
                            <div className="flex items-start text-sm">
                                <MapIcon className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                                <div>
                                    <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">Location</span>
                                    {childLessons[0].location || 'Main Arena'}
                                </div>
                            </div>
                            {childLessons[0].focus && (
                                <div className="flex items-start text-sm border-t border-white/20 pt-2 mt-2">
                                    <Activity className="w-4 h-4 mr-2 mt-0.5 opacity-80" />
                                    <div>
                                        <span className="opacity-70 text-xs uppercase tracking-wider font-bold block">Goal / Focus</span>
                                        {childLessons[0].focus}
                                    </div>
                                </div>
                            )}
                        </div>

                        {childLessons[0].status === 'Pending' && <div className="mt-3 inline-block bg-white/20 px-2 py-1 rounded text-xs font-bold">Pending Confirmation</div>}
                        {childLessons[0].status === 'Cancelled' && <div className="mt-3 inline-block bg-red-500 text-white px-2 py-1 rounded text-xs font-bold shadow-lg">CANCELLED</div>}
                        </div>
                    ) : (
                        <div className="py-8 text-center opacity-80 relative z-10">No upcoming lessons scheduled.</div>
                    )}
                </Card>

                {/* Progress Card (Mirrored) */}
                <Card className="p-6">
                    <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center"><Award className="w-5 h-5 mr-2 text-yellow-500" /> Stats & Achievements</h3>
                    <div className="flex flex-wrap gap-2 mb-6">
                        {/* Stats Badge */}
                        <span className="px-2 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 text-xs rounded border border-indigo-100 dark:border-indigo-800 flex items-center font-bold">
                            <CheckCircle className="w-3 h-3 mr-1" /> {completedLessonsCount} Lessons
                        </span>

                        {activeChild.achievements?.map((ach, i) => (
                        <span key={i} className="px-2 py-1 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs rounded border border-yellow-100 dark:border-yellow-800 flex items-center">
                            <Award className="w-3 h-3 mr-1" /> {ach}
                        </span>
                        ))}
                        {(!activeChild.achievements || activeChild.achievements.length === 0) && <span className="text-xs text-gray-400">No achievements yet.</span>}
                    </div>

                    {activeChild.milestone && (
                        <div className="mb-6 bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800">
                            <h4 className="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider mb-1 flex items-center">
                                <TrendingUp className="w-3 h-3 mr-1" /> Next Milestone
                            </h4>
                            <p className="text-indigo-900 dark:text-indigo-200 font-bold text-lg">{activeChild.milestone}</p>
                        </div>
                    )}

                    <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center"><FileText className="w-5 h-5 mr-2 text-gray-500" /> Recent Notes</h3>
                    <div className="space-y-4">
                        {activeChild.development?.slice(0,3).map((note, i) => (
                        <div key={i} className="bg-gray-50 dark:bg-slate-700 p-3 rounded-lg text-sm">
                            <div className="text-xs text-gray-400 mb-1">{safeDate(note.date).toLocaleDateString()}</div>
                            <p className="text-gray-700 dark:text-gray-300">{note.text}</p>
                        </div>
                        ))}
                        {(!activeChild.development || activeChild.development.length === 0) && <p className="text-gray-400 italic text-sm">No notes yet.</p>}
                    </div>
                </Card>
            </div>

            {/* Upcoming Schedule (Mirrored) */}
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white">{activeChild.name.split(' ')[0]}'s Schedule</h3>
                {settings.studentSelfBooking && (
                    <Button onClick={() => handleBookingRequest(activeChild.name)} icon={Plus} size="sm">Booking Request</Button>
                )}
            </div>
            <Card className="overflow-hidden mb-8">
                <div className="divide-y divide-gray-100 dark:divide-slate-700">
                    {childLessons.map(lesson => (
                        <div key={lesson.id} className={`p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-slate-700 ${lesson.status === 'Cancelled' ? 'bg-gray-50 dark:bg-slate-700' : ''}`}>
                            <div className={lesson.status === 'Cancelled' ? 'opacity-60' : ''}>
                                <p className={`font-semibold text-gray-900 dark:text-white ${lesson.status === 'Cancelled' ? 'line-through decoration-gray-400' : ''}`}>{lesson.title}</p>
                                <div className="flex items-center text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    <span className={lesson.status === 'Cancelled' ? 'line-through' : ''}>
                                        {safeDate(lesson.date).toLocaleDateString('en-GB')} {lesson.time || safeDate(lesson.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                        {lesson.timeEnd ? ` - ${lesson.timeEnd}` : ''}
                                    </span>
                                    {lesson.focus && <span className="ml-2 pl-2 border-l border-gray-300 dark:border-slate-600 italic text-gray-400">Focus: {lesson.focus}</span>}
                                </div>
                                <p className="text-xs text-indigo-600 dark:text-indigo-400 flex items-center mt-1 font-medium">
                                    <Horse className="w-3 h-3 mr-1" />
                                    Horse: {getParticipants(lesson).find(p => p.student === activeChild.name)?.horse || 'TBD'}
                                </p>
                            </div>
                            <div className="flex items-center gap-2">
                                {lesson.status === 'Pending' && <span className="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300 text-xs px-2 py-1 rounded-full font-medium">Pending</span>}
                                {lesson.status === 'Cancelled' && <span className="bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300 text-xs px-2 py-1 rounded-full font-bold">Cancelled</span>}
                                <Badge type={getSmartLessonColor(lesson)}>{lesson.type}</Badge>
                            </div>
                        </div>
                    ))}
                    {childLessons.length === 0 && <div className="p-8 text-center text-gray-500">No upcoming lessons for {activeChild.name}.</div>}
                </div>
            </Card>
        </div>
      )}

      <BookingRequestModal 
        isOpen={isBookingOpen} 
        onClose={() => setIsBookingOpen(false)} 
        onSubmit={(data) => onBookLesson(data)}
        students={myChildren}
        defaultStudent={selectedChildForBooking || (activeChild ? activeChild.name : '')}
      />
    </div>
  );
};

const StaffView = ({ staffMember, tasks, horses, lessons, inventory, settings, onToggleTask, onUpdateHorse, onNavigate, announcements }) => {
  const myTasks = tasks.filter(t => t.assignedTo === staffMember.name && t.status !== 'Completed');
  const lowStockItems = inventory.filter(i => Number(i.quantity) <= Number(i.reorderPoint));
  
  // Stats
  const activeHorseCount = horses.filter(h => h.status === 'Active').length;
  
  // Time Greeting
  const hour = new Date().getHours();
  const greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';

  if (!staffMember) return <div className="p-8 text-center text-gray-500">Loading staff profile...</div>;

  return (
    <div className="max-w-6xl mx-auto space-y-8">
      {/* Header & Stats */}
      <div className="flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 className="text-3xl font-bold text-gray-900 dark:text-white">{greeting}, {staffMember.name.split(' ')[0]} üëã</h1>
            <p className="text-gray-500 dark:text-slate-400 mt-1">Here's what's happening at the stable today.</p>
        </div>
        <div className="flex gap-3">
             <div className="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl border border-gray-100 dark:border-slate-700 shadow-sm text-center">
                <div className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">{myTasks.length}</div>
                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Tasks</div>
             </div>
             <div className="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl border border-gray-100 dark:border-slate-700 shadow-sm text-center">
                <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{activeHorseCount}</div>
                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Horses</div>
             </div>
             {settings.staffScheduleManagement && (
                 <Button size="md" variant="secondary" onClick={() => onNavigate && onNavigate('schedule')} icon={Calendar}>
                    Schedule
                 </Button>
             )}
        </div>
      </div>

      {/* Announcements */}
      <AnnouncementWidget announcements={announcements} />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Left Column: Tasks & Alerts */}
        <div className="space-y-8">
          
          {/* My Tasks - Improved UI */}
          <section>
            <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-gray-900 dark:text-white flex items-center"><ClipboardList className="w-5 h-5 mr-2 text-indigo-600" /> My Tasks</h3>
                <span className="text-xs font-medium text-gray-400">{myTasks.length} Pending</span>
            </div>
            
            <div className="space-y-3">
                {myTasks.map(task => (
                    <div key={task.id} className="group bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all flex items-start gap-3">
                        {/* Checkbox Action */}
                        <button 
                            onClick={() => onToggleTask(task)}
                            className="mt-1 w-5 h-5 rounded-full border-2 border-gray-300 dark:border-slate-500 text-transparent group-hover:border-emerald-500 group-hover:text-emerald-500 flex items-center justify-center transition-all flex-shrink-0"
                        >
                            <CheckCircle className="w-4 h-4 fill-current" />
                        </button>
                        
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-start mb-1">
                                <h4 className="font-bold text-gray-900 dark:text-white text-sm leading-tight">{task.title}</h4>
                                <Badge type={task.priority === 'High' ? 'danger' : 'warning'}>{task.priority}</Badge>
                            </div>
                            <p className="text-xs text-gray-500 dark:text-slate-400 line-clamp-2">{task.description}</p>
                        </div>
                    </div>
                ))}
                {myTasks.length === 0 && (
                    <div className="p-6 bg-gray-50 dark:bg-slate-700 rounded-xl border border-dashed border-gray-200 dark:border-slate-600 text-center text-sm text-gray-500">
                        <CheckCircle className="w-8 h-8 mx-auto mb-2 text-gray-300" />
                        All tasks completed!
                    </div>
                )}
            </div>
          </section>

          {/* Inventory Alerts - Improved UI */}
          {settings.staffInventoryControl && (
            <section>
                <div className="flex justify-between items-center mb-4">
                    <h3 className="font-bold text-gray-900 dark:text-white flex items-center"><AlertTriangle className="w-5 h-5 mr-2 text-rose-500" /> Low Stock</h3>
                </div>
                <Card className="p-0 overflow-hidden bg-white dark:bg-slate-800">
                    {lowStockItems.length > 0 ? (
                        <div className="divide-y divide-gray-50 dark:divide-slate-700">
                            {lowStockItems.map(item => {
                                // Mock percentage for visual flair (assuming reorder point is ~30% of max capacity)
                                const percentage = Math.min((item.quantity / (item.reorderPoint * 3)) * 100, 100); 
                                return (
                                    <div key={item.id} className="p-4 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold text-gray-800 dark:text-white text-sm">{item.name}</span>
                                            <span className="text-xs font-bold text-rose-600 bg-rose-50 dark:bg-rose-900/30 px-2 py-1 rounded-full">{item.quantity} {item.unit}</span>
                                        </div>
                                        <div className="w-full bg-gray-100 dark:bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                            <div className="bg-rose-500 h-full rounded-full" style={{ width: `${Math.max(percentage, 5)}%` }}></div>
                                        </div>
                                        <div className="flex justify-between items-center mt-2">
                                            <span className="text-[10px] text-gray-400">Reorder at {item.reorderPoint}</span>
                                            <button className="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 flex items-center">
                                                <Plus className="w-3 h-3 mr-1" /> Restock
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="p-6 text-center text-sm text-gray-500">Inventory levels are healthy.</div>
                    )}
                </Card>
            </section>
          )}
        </div>

        {/* Right Column: Feed & Schedule */}
        <div className="lg:col-span-2 space-y-8">
          
          {/* Feed List - Text Wrap Fix */}
          {settings.staffEditMedicalFeed && (
            <Card className="p-6">
              <h3 className="font-bold text-gray-900 dark:text-white mb-6 flex items-center text-lg"><Activity className="w-5 h-5 mr-2 text-indigo-500"/> Barn Status & Feed</h3>
              <div className="space-y-3">
                {horses.filter(h => h.status === 'Active').slice(0, 4).map(horse => (
                  <div key={horse.id} className="flex items-start p-3 bg-gray-50 dark:bg-slate-700 rounded-xl border border-gray-100 dark:border-slate-600 hover:border-indigo-100 transition-colors">
                    <div className="flex-shrink-0 mr-4 mt-1">
                      <div className={`${horse.stall.length > 3 ? 'px-2 rounded-lg text-xs min-w-[2.5rem]' : 'w-10 rounded-full text-sm'} h-10 bg-white dark:bg-slate-800 flex items-center justify-center font-bold border-2 border-indigo-100 dark:border-indigo-800 text-indigo-700 dark:text-indigo-400 shadow-sm`}>
                        {horse.stall}
                      </div>
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start">
                            <h4 className="font-bold text-gray-900 dark:text-white">{horse.name}</h4>
                            <span className="text-[10px] font-bold px-2 py-0.5 bg-white dark:bg-slate-800 rounded border border-gray-200 dark:border-slate-600 text-gray-500 uppercase">{horse.feed ? 'Has Feed' : 'No Feed Info'}</span>
                        </div>
                        <p className="text-sm text-gray-600 dark:text-slate-300 mt-1 whitespace-pre-wrap leading-relaxed">{horse.feed || 'Standard ration.'}</p>
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-4 text-center">
                <button onClick={() => onNavigate && onNavigate('horses')} className="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 transition-colors">View All Horses ‚Üí</button>
              </div>
            </Card>
          )}
         
          {/* Schedule - Timeline UI */}
          <Card className="p-6">
            <h3 className="font-bold text-gray-900 dark:text-white mb-6 flex items-center text-lg"><Clock className="w-5 h-5 mr-2 text-indigo-500"/> Upcoming Schedule</h3>
            <div className="relative pl-4 space-y-0">
              {/* Timeline Line */}
              <div className="absolute left-6 top-3 bottom-6 w-0.5 bg-gray-100 dark:bg-slate-700"></div>
              
              {lessons
                .filter(l => safeDate(l.date) >= new Date().setHours(0,0,0,0))
                .sort((a,b) => safeDate(a.date) - safeDate(b.date))
                .slice(0, 5)
                .map((lesson, idx) => {
                  const lessonDate = safeDate(lesson.date);
                  const isToday = lessonDate.toDateString() === new Date().toDateString();
                  const participants = getParticipants(lesson);
                  const mainStudent = participants[0]?.student || 'Group';
                  
                  return (
                    <div key={lesson.id} className="relative pl-8 pb-6 last:pb-0 group">
                      {/* Timeline Dot */}
                      <div className={`absolute left-0 top-1.5 w-4 h-4 rounded-full border-2 z-10 bg-white dark:bg-slate-700 ${isToday ? 'border-indigo-600 shadow-[0_0_0_4px_rgba(79,70,229,0.1)]' : 'border-gray-300 dark:border-slate-600'}`}></div>
                      
                      <div className="flex justify-between items-start">
                          <div>
                              <div className="flex items-center gap-2 mb-1">
                                  <span className={`text-sm font-bold font-mono ${isToday ? 'text-indigo-700 dark:text-indigo-400' : 'text-gray-900 dark:text-white'}`}>
                                    {lesson.time || lessonDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                    {lesson.timeEnd ? ` - ${lesson.timeEnd}` : ''}
                                  </span>
                                  {!isToday && <span className="text-xs text-gray-400 font-medium">{lessonDate.toLocaleDateString(undefined, {weekday:'short'})}</span>}
                                  {isToday && idx === 0 && <span className="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider animate-pulse">Next</span>}
                              </div>
                              <h4 className="font-bold text-gray-900 dark:text-white">{lesson.title}</h4>
                              <div className="flex items-center text-sm text-gray-500 dark:text-slate-400 mt-1 gap-3">
                                  <span className="flex items-center"><User className="w-3 h-3 mr-1"/> {mainStudent}</span>
                                  <span className="flex items-center"><MapIcon className="w-3 h-3 mr-1"/> {lesson.location}</span>
                              </div>
                          </div>
                          
                          {/* Student Avatar (Initials) */}
                          <div className="w-10 h-10 rounded-full bg-gray-50 dark:bg-slate-700 border border-gray-100 dark:border-slate-600 flex items-center justify-center text-gray-500 dark:text-slate-300 font-bold text-xs shadow-sm">
                              {mainStudent.split(' ').map(n=>n[0]).join('').slice(0,2)}
                          </div>
                      </div>
                    </div>
                  );
              })}
              {lessons.filter(l => safeDate(l.date) >= new Date().setHours(0,0,0,0)).length === 0 && <p className="text-sm text-gray-500 italic pl-8">No upcoming lessons scheduled.</p>}
            </div>
          </Card>
        </div>
      </div>
    </div>
  );
};

// ... Modules Implementation ...

const Dashboard = ({ horses, lessons, tasks, inventory, settings, seedData, onToggleTask, announcements }) => {
  const activeHorses = horses.filter(h => h.status === 'Active').length;
  const todayLessons = lessons.filter(l => {
    try {
      const d = safeDate(l.date);
      return d.toDateString() === new Date().toDateString();
    } catch(e) { return false; }
  }).length;

  const lowStockCount = (inventory || []).filter(i => Number(i.quantity) <= Number(i.reorderPoint)).length;
  const openTasks = tasks.filter(t => t.status !== 'Completed');

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-6">
        <div>
            <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Stable Overview</h1>
            <p className="text-gray-500 dark:text-slate-400 mt-1">Here's what's happening today, {new Date().toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric'})}.</p>
        </div>
        {horses.length === 0 && (
            <Button variant="secondary" onClick={seedData} icon={DatabaseIcon}>Reset Demo Data</Button>
        )}
      </div>

      {/* Announcements */}
      <AnnouncementWidget announcements={announcements} />

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card className="p-6 flex items-center space-x-4">
          <div className="p-3 bg-indigo-100 text-indigo-600 rounded-xl">
            <Horse className="w-8 h-8" />
          </div>
          <div>
            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Horses</p>
            <p className="text-3xl font-bold text-gray-900 dark:text-white">{activeHorses}</p>
          </div>
        </Card>
        <Card className="p-6 flex items-center space-x-4">
          <div className="p-3 bg-emerald-100 text-emerald-600 rounded-xl">
            <Calendar className="w-8 h-8" />
          </div>
          <div>
            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Lessons Today</p>
            <p className="text-3xl font-bold text-gray-900 dark:text-white">{todayLessons}</p>
          </div>
        </Card>
        <Card className="p-6 flex items-center space-x-4">
          <div className="p-3 bg-amber-100 text-amber-600 rounded-xl">
            <ClipboardList className="w-8 h-8" />
          </div>
          <div>
            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Open Tasks</p>
            <p className="text-3xl font-bold text-gray-900 dark:text-white">{openTasks.length}</p>
          </div>
        </Card>
        {/* Placeholder for Low Stock or Revenue */}
        <Card className="p-6 flex items-center space-x-4">
          <div className="p-3 bg-rose-100 text-rose-600 rounded-xl">
            <AlertTriangle className="w-8 h-8" />
          </div>
          <div>
            <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Low Stock</p>
            <p className="text-3xl font-bold text-gray-900 dark:text-white">{lowStockCount}</p>
          </div>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card className="p-6 lg:col-span-2">
          <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <Clock className="w-5 h-5 mr-2 text-indigo-600" />
            Today's Schedule
          </h3>
          <div className="space-y-4">
             {lessons.filter(l => safeDate(l.date).toDateString() === new Date().toDateString()).map(lesson => {
               const participants = getParticipants(lesson);
               let timeStr = lesson.time || '00:00';
               if (!lesson.time) {
                 try {
                   const d = safeDate(lesson.date);
                   timeStr = `${d.getHours().toString().padStart(2, '0')}:00`;
                 } catch(e) {}
               }
               
               return (
                <div key={lesson.id} className="flex items-center p-4 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl transition-colors border border-gray-100 dark:border-slate-700">
                  <div className="flex-shrink-0 w-16 text-center">
                    <span className="block text-sm font-bold text-indigo-600 dark:text-indigo-400">
                      {timeStr}
                    </span>
                  </div>
                  <div className="ml-4 flex-1">
                    <p className="text-base font-bold text-gray-900 dark:text-white">{lesson.title}</p>
                    <p className="text-sm text-gray-500 dark:text-slate-400">
                        {participants.map(p => p.student).join(', ') || 'Unknown'} ‚Ä¢ {lesson.location || 'Arena'}
                    </p>
                  </div>
                  <span className="px-3 py-1 bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 rounded-full text-xs font-bold">
                      {lesson.status || 'Scheduled'}
                  </span>
                </div>
               );
             })}
            {lessons.filter(l => safeDate(l.date).toDateString() === new Date().toDateString()).length === 0 && <p className="text-sm text-gray-500 italic p-4">No lessons scheduled for today.</p>}
          </div>
        </Card>

        <Card className="p-6">
           <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-6">Quick Tasks</h3>
           <div className="space-y-4">
               {openTasks.slice(0, 3).map(task => (
                   <div key={task.id} className="flex items-start">
                       <div 
                        onClick={() => onToggleTask && onToggleTask(task)}
                        className="flex-shrink-0 h-5 w-5 rounded-full border-2 border-gray-300 dark:border-slate-500 mt-0.5 cursor-pointer hover:border-indigo-500 hover:bg-gray-50 transition-colors"
                       ></div>
                       <div className="ml-3 text-sm">
                           <span className="font-medium text-gray-700 dark:text-slate-300">{task.title}</span>
                       </div>
                   </div>
               ))}
               {openTasks.length === 0 && <p className="text-gray-500 text-sm italic">All caught up!</p>}
           </div>
        </Card>
      </div>
    </div>
  );
};

// ... existing HorseCard, HorsesModule, StudentCard, StudentsModule, ScheduleModule, InventoryModule, TasksModule, ParentCard, ParentsModule, StaffCard, StaffListModule, SettingsSwitch, SettingsModule, MessageCenterModule ...

const HorseCard = ({ horse, onEdit, onDelete, onViewHistory, readOnly = false }) => {
    const [isExpanded, setIsExpanded] = useState(false);

    const getSortedMedical = (records) => {
        if (!records) return { upcoming: [], past: [] };
        const now = new Date();
        now.setHours(0,0,0,0);
        const sorted = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
        const upcoming = sorted.filter(r => new Date(r.date) >= now).sort((a,b) => new Date(a.date) - new Date(b.date));
        const past = sorted.filter(r => new Date(r.date) < now);
        return { upcoming, past };
    };

    const getAge = (dob) => {
        if (!dob) return null;
        const birth = new Date(dob);
        const now = new Date();
        let age = now.getFullYear() - birth.getFullYear();
        const m = now.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    };

    const { upcoming, past } = getSortedMedical(horse.medicalRecords);
    const visibleUpcoming = upcoming.slice(0, 5);
    const visiblePast = past.slice(0, 3);
    const showHistoryButton = (horse.medicalRecords && horse.medicalRecords.length > 0);
    const age = getAge(horse.dob);

    return (
        <Card className="group hover:shadow-md transition-all">
            <div className="p-5">
                {/* Header */}
                <div className="flex justify-between items-start mb-4">
                    <div className="flex-1 min-w-0 pr-4">
                        <h3 className="text-2xl font-bold text-gray-900 dark:text-white leading-tight mb-1 truncate">{horse.name}</h3>
                        <div className="flex items-center text-sm font-medium text-indigo-600 dark:text-indigo-400">
                            <MapPin className="w-3.5 h-3.5 mr-1.5 flex-shrink-0" />
                            <span className="bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded text-indigo-700 dark:text-indigo-300 border border-indigo-100 dark:border-indigo-800 truncate max-w-full">
                                {horse.stall}
                            </span>
                        </div>
                    </div>
                    {!readOnly && (
                    <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                        <button onClick={onEdit} className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-gray-100 dark:hover:bg-slate-700 rounded"><Settings className="w-4 h-4" /></button>
                        <button onClick={onDelete} className="p-1.5 text-gray-400 hover:text-rose-600 hover:bg-gray-100 dark:hover:bg-slate-700 rounded"><XIcon className="w-4 h-4" /></button>
                    </div>
                    )}
                </div>

                {/* Info Grid */}
                <div className="grid grid-cols-2 gap-2 mb-4">
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Status</span>
                        <Badge type={horse.status === 'Active' ? 'success' : 'warning'}>{horse.status}</Badge>
                    </div>
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Gender</span>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{horse.gender || 'Gelding'}</span>
                    </div>
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600 col-span-2">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Breed</span>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{horse.breed || 'Unknown'}</span>
                    </div>
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Age</span>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{age !== null ? `${age} yrs` : '-'}</span>
                    </div>
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Level</span>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{horse.skillLevel}</span>
                    </div>
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Height</span>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{horse.height || '-'}</span>
                    </div>
                    <div className="bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                        <span className="text-[10px] text-gray-500 dark:text-slate-400 uppercase font-bold block">Temperament</span>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{horse.temperament || '-'}</span>
                    </div>
                    <div className="bg-indigo-50/50 dark:bg-indigo-900/20 p-2 rounded border border-indigo-100 dark:border-indigo-800 flex justify-between items-center col-span-2">
                        <span className="text-[10px] text-indigo-800 dark:text-indigo-300 uppercase font-bold">Max Lessons / Day</span>
                        <span className="font-bold text-indigo-700 dark:text-indigo-400">{horse.maxDailyLessons || 2}</span>
                    </div>
                </div>

                {/* Toggle Button */}
                <button 
                    onClick={() => setIsExpanded(!isExpanded)}
                    className="w-full py-2 flex items-center justify-center text-xs font-bold text-gray-400 hover:text-indigo-600 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg transition-all mb-2"
                >
                    {isExpanded ? (
                        <><ChevronUp className="w-4 h-4 mr-1" /> Show Less</>
                    ) : (
                        <><ChevronDown className="w-4 h-4 mr-1" /> More Info</>
                    )}
                </button>

                {/* Collapsible Content */}
                {isExpanded && (
                    <div className="animate-in fade-in slide-in-from-top-2 duration-200">
                        {/* Feed Section */}
                        <div className="mb-4">
                            <span className="text-[10px] text-gray-400 uppercase font-bold block mb-1">Diet / Feed</span>
                            <div className="text-xs text-gray-700 dark:text-slate-300 bg-amber-50/50 dark:bg-amber-900/20 p-2 rounded border border-amber-100 dark:border-amber-800 whitespace-pre-wrap leading-relaxed">
                                {horse.feed || 'Standard ration.'}
                            </div>
                        </div>

                        {/* Public Notes */}
                        {horse.notes && (
                            <div className="mb-4">
                                <span className="text-[10px] text-gray-400 uppercase font-bold block mb-1">Notes</span>
                                <p className="text-xs text-gray-600 dark:text-slate-400 italic border-l-2 border-gray-200 dark:border-slate-600 pl-2 line-clamp-2">
                                    {horse.notes}
                                </p>
                            </div>
                        )}

                        {/* Medical Section */}
                        <div className="border-t border-gray-100 dark:border-slate-700 pt-3 mt-2">
                            <span className="text-[10px] text-gray-400 uppercase font-bold block mb-2 flex items-center">
                                <Activity className="w-3 h-3 mr-1" /> Medical History
                            </span>
                            
                            <div className="space-y-2">
                                {/* Upcoming */}
                                {visibleUpcoming.map((rec, i) => (
                                    <div key={`up-${i}`} className="flex justify-between items-start text-xs bg-red-50 dark:bg-red-900/20 p-1.5 rounded border border-red-100 dark:border-red-800">
                                        <div>
                                            <span className="font-bold text-red-700 dark:text-red-400 block">{rec.type} (Upcoming)</span>
                                            <span className="text-gray-600 dark:text-slate-300">{rec.notes}</span>
                                        </div>
                                        <span className="font-medium text-red-600 dark:text-red-400 whitespace-nowrap ml-2">{new Date(rec.date).toLocaleDateString()}</span>
                                    </div>
                                ))}

                                {/* Past */}
                                {visiblePast.map((rec, i) => (
                                    <div key={`past-${i}`} className="flex justify-between items-start text-xs text-gray-500 dark:text-slate-400">
                                        <div className="flex items-center gap-2 overflow-hidden">
                                            <span className="w-1.5 h-1.5 rounded-full bg-gray-300 dark:bg-slate-600 flex-shrink-0"></span>
                                            <span className="truncate">{rec.type}: {rec.notes}</span>
                                        </div>
                                        <span className="whitespace-nowrap ml-2 opacity-70 text-[10px]">{new Date(rec.date).toLocaleDateString()}</span>
                                    </div>
                                ))}
                                
                                {upcoming.length === 0 && past.length === 0 && (
                                    <span className="text-xs text-gray-300 italic pl-1">No medical records found.</span>
                                )}

                                {showHistoryButton && (
                                    <button 
                                        onClick={onViewHistory}
                                        className="w-full mt-2 py-1.5 text-xs font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 rounded transition-colors flex items-center justify-center"
                                    >
                                        <Eye className="w-3 h-3 mr-1.5"/> View Full History
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </Card>
    );
};

const HorsesModule = ({ horses, onAddHorse, onUpdateHorse, onDeleteHorse, readOnly = false }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [showFeedList, setShowFeedList] = useState(false);
  const [editingHorse, setEditingHorse] = useState(null);
  const [viewingHistoryHorse, setViewingHistoryHorse] = useState(null);
  const [horseToDelete, setHorseToDelete] = useState(null);
  const [modalTab, setModalTab] = useState('details');
  const [formData, setFormData] = useState({ name: '', stall: '', dob: '', status: 'Active', gender: 'Gelding', breed: 'Warmblood', feed: '', skillLevel: 'Beginner', temperament: '', height: '', notes: '', maxDailyLessons: 2, medicalRecords: [] });
  const [newMedical, setNewMedical] = useState({ date: '', type: 'Vet', notes: '' });
  const [isCustomBreed, setIsCustomBreed] = useState(false);

  // --- Filtering & Sorting State ---
  const [activeFilter, setActiveFilter] = useState('All');
  const [sortBy, setSortBy] = useState('name'); // 'name', 'newest', 'oldest'

  const COMMON_BREEDS = ['Warmblood', 'Thoroughbred', 'Quarter Horse', 'Arabian', 'Pony', 'Cob', 'Draft', 'Irish Sport Horse', 'Andalusian', 'Welsh', 'Friesian'];

  // Handle Create/Update
  const handleSubmit = (e) => { 
      e.preventDefault(); 
      if (editingHorse) {
          onUpdateHorse(editingHorse.id, formData); 
      } else {
          // Add createdAt timestamp for sorting
          onAddHorse({ ...formData, createdAt: new Date().toISOString() });
      }
      setIsModalOpen(false); 
      setEditingHorse(null); 
      setFormData({ name: '', stall: '', dob: '', status: 'Active', gender: 'Gelding', breed: 'Warmblood', feed: '', skillLevel: 'Beginner', temperament: '', height: '', notes: '', maxDailyLessons: 2, medicalRecords: [] }); 
  };
  
  const openEdit = (horse) => { 
      setEditingHorse(horse); 
      const currentBreed = horse.breed || 'Warmblood';
      setIsCustomBreed(!COMMON_BREEDS.includes(currentBreed));

      setFormData({ 
          ...horse, 
          dob: horse.dob || '',
          gender: horse.gender || 'Gelding', 
          breed: currentBreed,
          medicalRecords: horse.medicalRecords || [], 
          skillLevel: horse.skillLevel || 'Beginner', 
          temperament: horse.temperament || '', 
          height: horse.height || '', 
          notes: horse.notes || '', 
          maxDailyLessons: horse.maxDailyLessons || 2 
      }); 
      setModalTab('details'); 
      setIsModalOpen(true); 
  };

  const handleOpenAdd = () => {
      setEditingHorse(null); 
      setIsCustomBreed(false);
      setFormData({ name: '', stall: '', dob: '', status: 'Active', gender: 'Gelding', breed: 'Warmblood', feed: '', skillLevel: 'Beginner', temperament: '', height: '', notes: '', maxDailyLessons: 2, medicalRecords: [] }); 
      setModalTab('details'); 
      setIsModalOpen(true);
  };
  
  const addMedicalRecord = () => { if (!newMedical.date || !newMedical.notes) return; setFormData({ ...formData, medicalRecords: [newMedical, ...formData.medicalRecords] }); setNewMedical({ date: '', type: 'Vet', notes: '' }); };
  const deleteMedicalRecord = (index) => { setFormData({ ...formData, medicalRecords: formData.medicalRecords.filter((_, i) => i !== index) }); };

  // Helper to format medical records for display
  const getSortedMedical = (records) => {
      if (!records) return { upcoming: [], past: [] };
      const now = new Date();
      now.setHours(0,0,0,0);
      
      const sorted = [...records].sort((a,b) => new Date(b.date) - new Date(a.date));
      
      const upcoming = sorted.filter(r => new Date(r.date) >= now).sort((a,b) => new Date(a.date) - new Date(b.date));
      const past = sorted.filter(r => new Date(r.date) < now);
      
      return { upcoming, past };
  };

  // --- Filtering & Sorting Logic ---
  const uniqueLocations = useMemo(() => {
      const locations = horses.map(h => h.stall).filter(Boolean);
      return ['All', ...new Set(locations)].sort();
  }, [horses]);

  const processedHorses = useMemo(() => {
      let result = [...horses];
      if (activeFilter !== 'All') {
          result = result.filter(h => h.stall === activeFilter);
      }
      result.sort((a, b) => {
          if (sortBy === 'name') {
              return a.name.localeCompare(b.name);
          }
          if (sortBy === 'newest') {
              const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
              const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
              return dateB - dateA; // Descending
          }
          if (sortBy === 'oldest') {
              const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
              const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
              return dateA - dateB; // Ascending
          }
          return 0;
      });

      return result;
  }, [horses, activeFilter, sortBy]);

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-4">
          <div className="flex justify-between items-center">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Horse Management</h2>
              <div className="flex space-x-2">
                  <Button onClick={() => setShowFeedList(true)} variant="secondary" icon={ClipboardList}>Feed List</Button>
                  {!readOnly && <Button onClick={handleOpenAdd} icon={Plus}>Add Horse</Button>}
              </div>
          </div>
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white dark:bg-slate-800 p-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm">
              <div className="flex-1 overflow-x-auto no-scrollbar w-full">
                  <div className="flex space-x-2 px-1">
                      {uniqueLocations.map(loc => (
                          <button
                              key={loc}
                              onClick={() => setActiveFilter(loc)}
                              className={`px-3 py-1.5 text-xs font-medium rounded-lg whitespace-nowrap transition-colors border ${
                                  activeFilter === loc 
                                  ? 'bg-indigo-600 text-white border-indigo-600 shadow-sm' 
                                  : 'bg-white dark:bg-slate-700 text-gray-600 dark:text-slate-300 border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-600'
                              }`}
                          >
                              {loc}
                          </button>
                      ))}
                  </div>
              </div>
              <div className="flex items-center space-x-2 pl-2 border-l border-gray-200 dark:border-slate-700 flex-shrink-0">
                  <span className="text-xs font-bold text-gray-400 uppercase">Sort:</span>
                  <select 
                      value={sortBy} 
                      onChange={(e) => setSortBy(e.target.value)}
                      className="text-sm border-none bg-transparent font-medium text-gray-700 dark:text-white focus:ring-0 cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400"
                  >
                      <option className="dark:bg-slate-800" value="name">Alphabetical (A-Z)</option>
                      <option className="dark:bg-slate-800" value="newest">Newest First</option>
                      <option className="dark:bg-slate-800" value="oldest">Oldest First</option>
                  </select>
              </div>
          </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {processedHorses.map(horse => (
            <HorseCard 
                key={horse.id} 
                horse={horse} 
                onEdit={!readOnly ? () => openEdit(horse) : undefined} 
                onDelete={!readOnly ? () => setHorseToDelete(horse) : undefined}
                onViewHistory={() => setViewingHistoryHorse(horse)}
                readOnly={readOnly}
            />
        ))}
        {processedHorses.length === 0 && <div className="col-span-full text-center py-12 text-gray-500 bg-gray-50 dark:bg-slate-700 rounded-lg border border-dashed border-gray-300 dark:border-slate-600">No horses found matching this filter.</div>}
      </div>
      
      <Modal isOpen={!!horseToDelete} onClose={() => setHorseToDelete(null)} title="Confirm Deletion">
          <div className="space-y-4">
              <div className="flex items-start bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-800 text-red-800 dark:text-red-200">
                  <AlertTriangle className="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" />
                  <p className="text-sm">
                      Are you sure you want to delete <strong>{horseToDelete?.name}</strong>? 
                      This action cannot be undone and will remove all associated data.
                  </p>
              </div>
              <div className="flex justify-end space-x-3 pt-2">
                  <Button variant="secondary" onClick={() => setHorseToDelete(null)}>Cancel</Button>
                  <Button variant="danger" onClick={() => { onDeleteHorse(horseToDelete.id); setHorseToDelete(null); }} icon={Trash2}>Delete Horse</Button>
              </div>
          </div>
      </Modal>

      <Modal isOpen={!!viewingHistoryHorse} onClose={() => setViewingHistoryHorse(null)} title={`Medical History: ${viewingHistoryHorse?.name}`}>
          {viewingHistoryHorse && (
              <div className="space-y-6">
                 {(() => {
                     const { upcoming, past } = getSortedMedical(viewingHistoryHorse.medicalRecords);
                     return (
                         <>
                            <div>
                                <h4 className="font-bold text-gray-900 dark:text-white mb-3 flex items-center text-sm uppercase tracking-wide">
                                    <Calendar className="w-4 h-4 mr-2 text-red-500"/> Upcoming
                                </h4>
                                {upcoming.length > 0 ? (
                                    <div className="space-y-3">
                                        {upcoming.map((rec, i) => (
                                            <div key={i} className="flex justify-between items-start bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-800">
                                                <div>
                                                    <span className="font-bold text-red-700 dark:text-red-400 block">{rec.type} (Upcoming)</span>
                                                    <p className="text-sm text-gray-700 dark:text-slate-300 mt-1">{rec.notes}</p>
                                                </div>
                                                <span className="font-bold text-red-600 dark:text-red-400 bg-white dark:bg-slate-700 px-2 py-1 rounded text-xs border border-red-100 dark:border-red-800 shadow-sm whitespace-nowrap">
                                                    {new Date(rec.date).toLocaleDateString()}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                ) : <p className="text-sm text-gray-500 italic">No upcoming events.</p>}
                            </div>

                            <div className="border-t border-gray-100 dark:border-slate-700 pt-4">
                                <h4 className="font-bold text-gray-900 dark:text-white mb-3 flex items-center text-sm uppercase tracking-wide">
                                    <Clock className="w-4 h-4 mr-2 text-gray-400"/> Past History
                                </h4>
                                {past.length > 0 ? (
                                    <div className="relative border-l-2 border-gray-100 dark:border-slate-700 ml-2 space-y-6 pl-4 pb-2">
                                        {past.map((rec, i) => (
                                            <div key={i} className="relative">
                                                <div className="absolute -left-[21px] top-1.5 w-3 h-3 rounded-full bg-gray-300 dark:bg-slate-600 border-2 border-white dark:border-slate-800"></div>
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <span className="font-bold text-gray-800 dark:text-white text-sm">{rec.type}</span>
                                                        <p className="text-sm text-gray-600 dark:text-slate-400 mt-0.5">{rec.notes}</p>
                                                    </div>
                                                    <span className="text-xs text-gray-400 font-mono whitespace-nowrap">
                                                        {new Date(rec.date).toLocaleDateString()}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : <p className="text-sm text-gray-500 italic">No past history recorded.</p>}
                            </div>
                         </>
                     );
                 })()}
              </div>
          )}
          <div className="mt-6 pt-4 border-t border-gray-100 dark:border-slate-700 flex justify-end">
              <Button variant="secondary" onClick={() => setViewingHistoryHorse(null)}>Close</Button>
          </div>
      </Modal>

      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingHorse ? "Edit Horse" : "Add New Horse"}>
        <div className="flex border-b border-gray-200 dark:border-slate-700 mb-4"><button onClick={() => setModalTab('details')} className={`flex-1 pb-2 text-sm font-medium ${modalTab === 'details' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200'}`}>Details</button><button onClick={() => setModalTab('medical')} className={`flex-1 pb-2 text-sm font-medium ${modalTab === 'medical' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200'}`}>Medical</button></div>
        <form onSubmit={handleSubmit}>
            {modalTab === 'details' && (
                <>
                    <Input label="Name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                    <div className="grid grid-cols-2 gap-4">
                        <Input label="Stall / Location" value={formData.stall} onChange={e => setFormData({...formData, stall: e.target.value})} required />
                        <Select label="Status" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                            <option>Active</option>
                            <option>Rest</option>
                            <option>Medical</option>
                            <option>Sold</option>
                        </Select>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <Input label="Date of Birth" type="date" value={formData.dob} onChange={e => setFormData({...formData, dob: e.target.value})} />
                        <Select label="Gender" value={formData.gender} onChange={e => setFormData({...formData, gender: e.target.value})}>
                            <option>Gelding</option>
                            <option>Mare</option>
                            <option>Stallion</option>
                        </Select>
                    </div>
                    
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Breed</label>
                        {!isCustomBreed ? (
                            <select 
                                className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                value={formData.breed}
                                onChange={(e) => {
                                    if (e.target.value === 'custom_breed_val') {
                                        setIsCustomBreed(true);
                                        setFormData({...formData, breed: ''});
                                    } else {
                                        setFormData({...formData, breed: e.target.value});
                                    }
                                }}
                            >
                                {COMMON_BREEDS.map(b => <option key={b} value={b}>{b}</option>)}
                                <option value="custom_breed_val">+ Custom / Other...</option>
                            </select>
                        ) : (
                            <div className="flex gap-2">
                                <input 
                                    className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                    placeholder="Enter breed"
                                    value={formData.breed}
                                    onChange={(e) => setFormData({...formData, breed: e.target.value})}
                                    autoFocus
                                />
                                <Button variant="secondary" onClick={() => setIsCustomBreed(false)}>Cancel</Button>
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                        <Select label="Skill Level" value={formData.skillLevel} onChange={e => setFormData({...formData, skillLevel: e.target.value})}>
                            <option>Beginner</option>
                            <option>Intermediate</option>
                            <option>Advanced</option>
                            <option>Pro Only</option>
                        </Select>
                        <Input label="Height" placeholder="e.g. 16.2hh" value={formData.height} onChange={e => setFormData({...formData, height: e.target.value})} />
                        <Input type="number" label="Max Lessons/Day" value={formData.maxDailyLessons} onChange={e => setFormData({...formData, maxDailyLessons: e.target.value})} />
                    </div>

                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Feed / Diet</label>
                        <textarea
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            rows="2"
                            value={formData.feed}
                            onChange={e => setFormData({...formData, feed: e.target.value})}
                        />
                    </div>
                    
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Notes</label>
                        <textarea
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            rows="2"
                            value={formData.notes}
                            onChange={e => setFormData({...formData, notes: e.target.value})}
                        />
                    </div>
                </>
            )}

            {modalTab === 'medical' && (
                <div className="space-y-4">
                    <div className="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg border border-gray-200 dark:border-slate-600">
                        <h4 className="text-sm font-bold text-gray-900 dark:text-white mb-3">Add New Record</h4>
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <Input type="date" label="Date" value={newMedical.date} onChange={e => setNewMedical({...newMedical, date: e.target.value})} className="mb-0" />
                            <Select label="Type" value={newMedical.type} onChange={e => setNewMedical({...newMedical, type: e.target.value})} className="mb-0">
                                <option>Vet</option>
                                <option>Farrier</option>
                                <option>Vaccination</option>
                                <option>Dentist</option>
                                <option>Physio</option>
                                <option>Other</option>
                            </Select>
                        </div>
                        <Input label="Notes" value={newMedical.notes} onChange={e => setNewMedical({...newMedical, notes: e.target.value})} className="mb-3" />
                        <Button onClick={addMedicalRecord} size="sm" icon={Plus}>Add Record</Button>
                    </div>

                    <div className="max-h-60 overflow-y-auto">
                        {formData.medicalRecords?.map((rec, i) => (
                            <div key={i} className="flex justify-between items-start p-3 border-b border-gray-100 dark:border-slate-700 last:border-0">
                                <div>
                                    <span className="text-xs font-bold uppercase text-gray-500 dark:text-slate-400">{rec.type}</span>
                                    <p className="text-sm text-gray-900 dark:text-white">{rec.notes}</p>
                                    <span className="text-xs text-gray-400">{new Date(rec.date).toLocaleDateString()}</span>
                                </div>
                                <button type="button" onClick={() => deleteMedicalRecord(i)} className="text-gray-400 hover:text-red-500">
                                    <Trash2 className="w-4 h-4" />
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            )}
            <div className="flex justify-end pt-4"><Button type="submit">Save</Button></div>
        </form>
      </Modal>
    </div>
  );
};

const StudentCard = ({ s, parents, lessons, onEdit, onDelete }) => {
  const [isExpanded, setIsExpanded] = useState(false);

  // Calculate recent horses from lesson history
  const recentHorses = useMemo(() => {
      if (!lessons || !s.name) return [];
      const history = lessons
        .filter(l => {
             // Look for past or today's lessons where student participated
             const d = safeDate(l.date);
             return d <= new Date() && (l.student === s.name || l.attendees?.some(a => a.student === s.name));
        })
        .sort((a,b) => safeDate(b.date) - safeDate(a.date)); // Newest first
      
      const names = history.map(l => {
          if (l.student === s.name) return l.horse;
          return l.attendees?.find(a => a.student === s.name)?.horse;
      }).filter(Boolean); // Remove null/undefined
      
      return [...new Set(names)].slice(0, 3); // Top 3 unique horses
  }, [lessons, s.name]);

  return (
    <Card className="p-5 flex flex-col gap-3 h-full">
        <div className="flex justify-between items-start">
            <div className="flex items-center gap-3">
                 <div className="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 flex-shrink-0">
                    <GraduationCap className="w-5 h-5"/>
                </div>
                <div>
                    <h3 className="text-lg font-bold leading-tight text-gray-900 dark:text-white">{s.name}</h3>
                    <div className="flex flex-wrap gap-2 mt-1">
                        <Badge>{s.type}</Badge>
                        {s.dob && <span className="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 px-1.5 py-0.5 rounded border border-gray-200 dark:border-slate-600">Born: {safeDate(s.dob).toLocaleDateString('en-GB')}</span>}
                    </div>
                </div>
            </div>
            <div className="flex gap-1 flex-shrink-0">
                <button onClick={onEdit} className="p-1 text-gray-400 hover:text-indigo-600 rounded hover:bg-gray-100 dark:hover:bg-slate-700"><Settings className="w-4 h-4"/></button>
                <button onClick={onDelete} className="p-1 text-gray-400 hover:text-rose-500 rounded hover:bg-gray-100 dark:hover:bg-slate-700"><XIcon className="w-4 h-4"/></button>
            </div>
        </div>

        {/* Contact & Parent Info */}
        <div className="text-sm text-gray-600 dark:text-slate-400 space-y-1.5 bg-gray-50 dark:bg-slate-700 p-2.5 rounded-lg border border-gray-100 dark:border-slate-600">
            {s.email && <div className="flex items-center gap-2 truncate"><Mail className="w-3.5 h-3.5 text-gray-400"/> {s.email}</div>}
            {s.phone && <div className="flex items-center gap-2 truncate"><Phone className="w-3.5 h-3.5 text-gray-400"/> {s.phone}</div>}
            {s.address && <div className="flex items-center gap-2 truncate"><MapPin className="w-3.5 h-3.5 text-gray-400"/> {s.address}</div>}
            {s.instagram && <div className="flex items-center gap-2 truncate"><Instagram className="w-3.5 h-3.5 text-pink-500"/> {s.instagram}</div>}
            {s.facebook && <div className="flex items-center gap-2 truncate"><Facebook className="w-3.5 h-3.5 text-blue-600"/> {s.facebook}</div>}
            {s.whatsapp && <div className="flex items-center gap-2 truncate"><MessageCircle className="w-3.5 h-3.5 text-green-500"/> {s.whatsapp}</div>}
            {s.parentId && (() => {
                const parentName = parents.find(p => p.id === s.parentId)?.name;
                return parentName ? <div className="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-medium pt-1 border-t border-gray-200 dark:border-slate-600 mt-1"><Users className="w-3.5 h-3.5"/> Parent: {parentName}</div> : null;
            })()}
            {!s.email && !s.phone && !s.parentId && !s.address && !s.instagram && !s.facebook && !s.whatsapp && <span className="text-xs text-gray-400 italic">No contact info</span>}
        </div>

        {/* Recent Horses - Visible Immediately */}
        {recentHorses.length > 0 && (
            <div className="px-1">
                <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-slate-400 mb-1 font-medium uppercase tracking-wider">
                    <Horse className="w-3 h-3"/> Recently Ridden
                </div>
                <div className="flex flex-wrap gap-1">
                    {recentHorses.map(horse => (
                        <span key={horse} className="text-[10px] px-1.5 py-0.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 border border-indigo-100 dark:border-indigo-800 rounded font-medium">
                            {horse}
                        </span>
                    ))}
                </div>
            </div>
        )}

        {/* Toggle Button */}
        <button 
            onClick={() => setIsExpanded(!isExpanded)}
            className="w-full py-2 flex items-center justify-center text-xs font-bold text-gray-400 hover:text-indigo-600 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg transition-all mt-1"
        >
            {isExpanded ? (
                <><ChevronUp className="w-4 h-4 mr-1" /> Show Less</>
            ) : (
                <><ChevronDown className="w-4 h-4 mr-1" /> More Info</>
            )}
        </button>

        {isExpanded && (
            <div className="animate-in fade-in slide-in-from-top-2 duration-200 space-y-3">
                {/* Milestone */}
                {s.milestone && (
                    <div className="text-sm border-l-2 border-indigo-400 pl-3 py-1 bg-indigo-50/50 dark:bg-indigo-900/20 rounded-r">
                        <span className="font-bold text-gray-500 dark:text-slate-400 text-[10px] uppercase tracking-wider block mb-0.5">Current Focus</span>
                        <span className="text-gray-900 dark:text-white font-medium">{s.milestone}</span>
                    </div>
                )}

                {/* Skills */}
                {s.skills && s.skills.length > 0 && (
                    <div>
                        <span className="font-bold text-gray-400 text-[10px] uppercase tracking-wider block mb-1.5">Skills Progress</span>
                        <div className="flex flex-wrap gap-1.5">
                            {s.skills.map((skill, i) => (
                                <span key={i} className={`text-[10px] px-2 py-0.5 rounded-full border font-medium flex items-center ${skill.status === 'Mastered' ? 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 border-emerald-200 dark:border-emerald-800' : 'bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 border-amber-200 dark:border-amber-800'}`}>
                                    {skill.status === 'Mastered' && <CheckCircle className="w-2.5 h-2.5 mr-1"/>}
                                    {skill.name}
                                </span>
                            ))}
                        </div>
                    </div>
                )}

                {/* Achievements */}
                {s.achievements && s.achievements.length > 0 && (
                    <div>
                        <span className="font-bold text-gray-400 text-[10px] uppercase tracking-wider block mb-1.5">Achievements</span>
                        <div className="flex flex-wrap gap-1.5">
                            {s.achievements.map((ach, i) => (
                                <span key={i} className="text-[10px] px-2 py-0.5 rounded-full border bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-800 flex items-center font-medium">
                                <Award className="w-2.5 h-2.5 mr-1"/> {ach}
                                </span>
                            ))}
                        </div>
                    </div>
                )}

                {/* Latest Development Note */}
                {s.development && s.development.length > 0 && (
                    <div className="pt-3 border-t border-gray-100 dark:border-slate-700">
                        <div className="flex justify-between items-baseline mb-1">
                            <span className="font-bold text-gray-400 text-[10px] uppercase tracking-wider">Latest Note</span>
                            <span className="text-[10px] text-gray-400">{safeDate(s.development[0].date).toLocaleDateString()}</span>
                        </div>
                        <p className="text-xs text-gray-600 dark:text-slate-400 bg-gray-50 dark:bg-slate-700 p-2 rounded italic">"{s.development[0].text}"</p>
                    </div>
                )}
            </div>
        )}
    </Card>
  );
};

const StudentsModule = ({ students, parents, lessons, onAddStudent, onUpdateStudent, onDeleteStudent }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingStudent, setEditingStudent] = useState(null);
  const [formData, setFormData] = useState({ name: '', type: 'Adult', parentId: '', email: '', phone: '', dob: '', address: '', instagram: '', facebook: '', whatsapp: '', achievements: [], development: [], skills: [], milestone: '' });
  const [newAchievement, setNewAchievement] = useState('');
  const [newSkill, setNewSkill] = useState('');
  const [newNote, setNewNote] = useState('');

  // --- Filtering & Sorting State ---
  const [activeFilter, setActiveFilter] = useState('All');
  const [sortBy, setSortBy] = useState('name');

  const PRESET_ACHIEVEMENTS = [
      "First Canter üéâ", 
      "First Jump Course üöß", 
      "Rode Without Lead Line üåü", 
      "No Stirrups Master üí™", 
      "Consistency Streak (4 Weeks) üî•",
      "Completed 10 Lessons üèÖ",
      "Completed 50 Lessons üèÜ"
  ];

  const handleSubmit = (e) => { 
      e.preventDefault(); 
      if(editingStudent) {
          onUpdateStudent(editingStudent.id, formData); 
      } else {
          onAddStudent({ ...formData, createdAt: new Date().toISOString() }); 
      }
      setIsModalOpen(false); 
  };
  const handleAddAchievement = () => {
      if(!newAchievement.trim()) return;
      setFormData(prev => ({ ...prev, achievements: [...(prev.achievements || []), newAchievement.trim()] }));
      setNewAchievement('');
  };
  const handleRemoveAchievement = (index) => {
      setFormData(prev => ({ ...prev, achievements: prev.achievements.filter((_, i) => i !== index) }));
  };
  const handleAddSkill = () => {
      if(!newSkill.trim()) return;
      setFormData(prev => ({ ...prev, skills: [...(prev.skills || []), { name: newSkill.trim(), status: 'Learning' }] }));
      setNewSkill('');
  };
  const handleToggleSkill = (index) => {
      setFormData(prev => {
          const updated = [...(prev.skills || [])];
          updated[index].status = updated[index].status === 'Learning' ? 'Mastered' : 'Learning';
          return { ...prev, skills: updated };
      });
  };
  const handleRemoveSkill = (index) => {
      setFormData(prev => ({ ...prev, skills: prev.skills.filter((_, i) => i !== index) }));
  };
  const handleAddNote = () => {
      if(!newNote.trim()) return;
      const note = { date: new Date(), text: newNote.trim() };
      setFormData(prev => ({ ...prev, development: [note, ...(prev.development || [])] }));
      setNewNote('');
  };

  // --- Logic ---
  const uniqueTypes = useMemo(() => {
      const types = students.map(s => s.type).filter(Boolean);
      return ['All', ...new Set(types)].sort();
  }, [students]);

  const processedStudents = useMemo(() => {
      let result = [...students];
      if (activeFilter !== 'All') {
          result = result.filter(s => s.type === activeFilter);
      }
      result.sort((a, b) => {
          if (sortBy === 'name') return a.name.localeCompare(b.name);
          if (sortBy === 'newest') {
              const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
              const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
              return dateB - dateA;
          }
          if (sortBy === 'oldest') {
              const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
              const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
              return dateA - dateB;
          }
          return 0;
      });
      return result;
  }, [students, activeFilter, sortBy]);

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-4">
        <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Students</h2>
            <Button onClick={() => { setEditingStudent(null); setFormData({name:'', type:'Adult', parentId:'', email:'', phone:'', dob: '', address: '', instagram: '', facebook: '', whatsapp: '', achievements:[], development:[], skills: [], milestone: ''}); setIsModalOpen(true); }} icon={Plus}>Add Student</Button>
        </div>

        {/* Controls Row */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white dark:bg-slate-800 p-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm">
            <div className="flex-1 overflow-x-auto no-scrollbar w-full">
                <div className="flex space-x-2 px-1">
                    {uniqueTypes.map(type => (
                        <button
                            key={type}
                            onClick={() => setActiveFilter(type)}
                            className={`px-3 py-1.5 text-xs font-medium rounded-lg whitespace-nowrap transition-colors border ${
                                activeFilter === type 
                                ? 'bg-indigo-600 text-white border-indigo-600 shadow-sm' 
                                : 'bg-white dark:bg-slate-700 text-gray-600 dark:text-slate-300 border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-600'
                            }`}
                        >
                            {type}
                        </button>
                    ))}
                </div>
            </div>
            <div className="flex items-center space-x-2 pl-2 border-l border-gray-200 dark:border-slate-700 flex-shrink-0">
                <span className="text-xs font-bold text-gray-400 uppercase">Sort:</span>
                <select 
                    value={sortBy} 
                    onChange={(e) => setSortBy(e.target.value)}
                    className="text-sm border-none bg-transparent font-medium text-gray-700 dark:text-white focus:ring-0 cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400"
                >
                    <option className="dark:bg-slate-800" value="name">Alphabetical (A-Z)</option>
                    <option className="dark:bg-slate-800" value="newest">Newest First</option>
                    <option className="dark:bg-slate-800" value="oldest">Oldest First</option>
                </select>
            </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {processedStudents.map(s => (
            <StudentCard 
                key={s.id} 
                s={s} 
                parents={parents}
                lessons={lessons}
                onEdit={() => { setEditingStudent(s); setFormData(s); setIsModalOpen(true); }}
                onDelete={() => onDeleteStudent(s.id)}
            />
        ))}
        {processedStudents.length === 0 && <div className="col-span-full text-center py-12 text-gray-500 bg-gray-50 dark:bg-slate-700 rounded-lg border border-dashed border-gray-300 dark:border-slate-600">No students found matching this filter.</div>}
      </div>
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingStudent ? "Edit Student" : "New Student"}>
          <form onSubmit={handleSubmit}>
              <Input label="Name" value={formData.name || ''} onChange={e=>setFormData({...formData, name:e.target.value})} required />
              <div className="grid grid-cols-2 gap-4">
                  <Select label="Type" value={formData.type || 'Adult'} onChange={e=>setFormData({...formData, type:e.target.value})}><option>Adult</option><option>Junior</option></Select>
                  <Input label="Date of Birth" type="date" value={formData.dob || ''} onChange={e=>setFormData({...formData, dob:e.target.value})} />
              </div>
              {formData.type==='Junior' && <Select label="Parent" value={formData.parentId || ''} onChange={e=>setFormData({...formData, parentId:e.target.value})}><option value="">Select...</option>{parents.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</Select>}
              <Input label="Email" value={formData.email || ''} onChange={e=>setFormData({...formData, email:e.target.value})} />
              <Input label="Phone" value={formData.phone || ''} onChange={e=>setFormData({...formData, phone:e.target.value})} />
              <Input label="Address" value={formData.address || ''} onChange={e=>setFormData({...formData, address:e.target.value})} />
              
              <div className="grid grid-cols-3 gap-3">
                  <Input label="Instagram" placeholder="@..." value={formData.instagram || ''} onChange={e=>setFormData({...formData, instagram:e.target.value})} />
                  <Input label="Facebook" placeholder="Name/URL" value={formData.facebook || ''} onChange={e=>setFormData({...formData, facebook:e.target.value})} />
                  <Input label="WhatsApp" placeholder="+1..." value={formData.whatsapp || ''} onChange={e=>setFormData({...formData, whatsapp:e.target.value})} />
              </div>

              <div className="mt-6 border-t border-gray-100 dark:border-slate-700 pt-6 space-y-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-900 dark:text-white mb-2">Next Milestone</label>
                    <Input placeholder="e.g. Cantering independently" value={formData.milestone || ''} onChange={e => setFormData({...formData, milestone: e.target.value})} className="mb-0" />
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-900 dark:text-white mb-2">Skills Tracker</label>
                    <div className="flex gap-2 mb-3">
                        <input className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white" placeholder="New Skill (e.g. Posting Trot)" value={newSkill} onChange={e => setNewSkill(e.target.value)} />
                        <Button type="button" onClick={handleAddSkill} size="sm" icon={Plus}>Add</Button>
                    </div>
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                        {(formData.skills || []).map((skill, i) => (
                            <div key={i} className="flex justify-between items-center bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                                <span 
                                    onClick={() => handleToggleSkill(i)} 
                                    className="cursor-pointer flex items-center flex-1 text-sm font-medium"
                                >
                                    {skill.status === 'Mastered' 
                                        ? <CheckCircle className="w-4 h-4 text-emerald-500 mr-2" /> 
                                        : <Clock className="w-4 h-4 text-amber-500 mr-2" />
                                    }
                                    <span className={skill.status === 'Mastered' ? 'text-emerald-900 dark:text-emerald-400' : 'text-gray-700 dark:text-slate-300'}>{skill.name}</span>
                                </span>
                                <button type="button" onClick={() => handleRemoveSkill(i)} className="text-gray-400 hover:text-rose-500 ml-2"><XIcon className="w-4 h-4" /></button>
                            </div>
                        ))}
                        {(formData.skills || []).length === 0 && <p className="text-xs text-gray-400 italic">No skills added yet.</p>}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-900 dark:text-white mb-2">Achievements</label>
                    <div className="flex flex-col gap-2 mb-2">
                        <select 
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            onChange={e => {
                                if (e.target.value) {
                                    setNewAchievement(e.target.value);
                                }
                            }}
                            value=""
                        >
                            <option value="">-- Quick Select Milestone --</option>
                            {PRESET_ACHIEVEMENTS.map(pa => <option key={pa} value={pa}>{pa}</option>)}
                        </select>
                        <div className="flex gap-2">
                            <input className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white" placeholder="Or type custom achievement..." value={newAchievement} onChange={e => setNewAchievement(e.target.value)} />
                            <Button type="button" onClick={handleAddAchievement} size="sm" icon={Plus}>Add</Button>
                        </div>
                    </div>
                    <div className="flex flex-wrap gap-2 mb-4">
                        {(formData.achievements || []).map((ach, i) => (
                            <span key={i} className="px-2 py-1 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs rounded border border-yellow-100 dark:border-yellow-800 flex items-center">
                                {ach} <button type="button" onClick={() => handleRemoveAchievement(i)} className="ml-1 text-yellow-500 hover:text-yellow-700"><XIcon className="w-3 h-3" /></button>
                            </span>
                        ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-900 dark:text-white mb-2">Development Notes</label>
                    <div className="flex gap-2 mb-2">
                        <input className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-white" placeholder="Add note..." value={newNote} onChange={e => setNewNote(e.target.value)} />
                        <Button type="button" onClick={handleAddNote} size="sm" icon={Plus}>Add</Button>
                    </div>
                    <div className="max-h-32 overflow-y-auto space-y-2">
                        {(formData.development || []).map((note, i) => (
                            <div key={i} className="text-xs bg-gray-50 dark:bg-slate-700 p-2 rounded border border-gray-100 dark:border-slate-600">
                                <span className="text-gray-400 block">{safeDate(note.date).toLocaleDateString()}</span>
                                <span className="text-gray-900 dark:text-slate-300">{note.text}</span>
                            </div>
                        ))}
                    </div>
                  </div>
              </div>
              <div className="flex justify-end pt-4"><Button type="submit">Save</Button></div>
          </form>
      </Modal>
    </div>
  );
};

// ... existing ScheduleModule, InventoryModule, TasksModule, ParentCard, ParentsModule, StaffCard, StaffListModule, SettingsSwitch, SettingsModule ...

const ScheduleModule = ({ lessons, horses, students, staff, settings, onAddLesson, onUpdateLesson, onDeleteLesson, onUpdateStudent, readOnly = false }) => {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [viewMode, setViewMode] = useState('month'); // 'month' or 'list'
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({ title: '', date: '', time: '09:00', timeEnd: '', instructor: '', type: 'Private', location: 'Main Arena', student: '', horse: '', attendees: [], isRecurring: false, recurrenceWeeks: 4, comment: '', focus: '', equipment: '', outcomes: {} });
    const [editingId, setEditingId] = useState(null);
    const [attendeeInput, setAttendeeInput] = useState('');
    const [attendeeHorse, setAttendeeHorse] = useState(''); // New state for horse selection in groups
    const [isInstructorManual, setIsInstructorManual] = useState(false);
    const [isStudentManual, setIsStudentManual] = useState(false);
    const [isHorseManual, setIsHorseManual] = useState(false);
    const [feedback, setFeedback] = useState({ achievement: '', note: '' });
    const [feedbackStudent, setFeedbackStudent] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        const dateObj = new Date(formData.date + 'T' + formData.time);
        
        // Update outcomes map with current feedback
        const targetStudent = formData.student || feedbackStudent;
        let currentOutcomes = { ...(formData.outcomes || {}) };
        
        if (targetStudent) {
            if (feedback.achievement || feedback.note) {
                currentOutcomes[targetStudent] = feedback;
            } else {
                delete currentOutcomes[targetStudent];
            }
        }

        // Strict separation of Edit vs Create logic to prevent accidental bulk updates
        if (editingId) {
            // EDIT MODE: Always update ONLY the specific lesson being edited
            const data = { ...formData, date: dateObj, outcomes: currentOutcomes };
            delete data.isRecurring; 
            delete data.recurrenceWeeks;
            delete data.id; // Ensure ID is not saved as a field
            onUpdateLesson(editingId, data);
        } else {
            // CREATE MODE: Handle single or recurring creation
            if (formData.isRecurring) {
                for (let i = 0; i < (formData.recurrenceWeeks || 1); i++) {
                    const nextDate = new Date(dateObj);
                    nextDate.setDate(nextDate.getDate() + (i * 7));
                    const data = { ...formData, date: nextDate, outcomes: {} }; // New recurring lessons start empty
                    delete data.isRecurring; 
                    delete data.recurrenceWeeks;
                    onAddLesson(data);
                }
            } else {
                const data = { ...formData, date: dateObj, outcomes: currentOutcomes };
                delete data.isRecurring; 
                delete data.recurrenceWeeks;
                onAddLesson(data);
            }
        }

        // Handle Student Update (Historical Log - Append Only)
        if (editingId && targetStudent && (feedback.achievement || feedback.note)) {
            const studentObj = students.find(s => s.name === targetStudent);
            if (studentObj && onUpdateStudent) {
                const updates = {};
                if (feedback.achievement) {
                    // Check if unique to avoid simple duplicates in the log
                    if (!studentObj.achievements?.includes(feedback.achievement)) {
                        updates.achievements = [...(studentObj.achievements || []), feedback.achievement];
                    }
                }
                if (feedback.note) {
                    const currentDev = studentObj.development || [];
                    // Prevent duplicate if text matches the latest entry (avoids duplication on re-saves)
                    if (currentDev.length === 0 || currentDev[0].text !== feedback.note) {
                        const newNote = { date: new Date(), text: feedback.note };
                        updates.development = [newNote, ...currentDev];
                    }
                }
                if (Object.keys(updates).length > 0) {
                    onUpdateStudent(studentObj.id, updates);
                }
            }
        }
        setIsModalOpen(false);
    };

    // Helper for calendar coloring
    const getCalendarColor = (lesson) => {
        // Immediate check for cancelled status
        if (lesson.status === 'Cancelled') {
            return 'bg-gray-50 border-gray-200 text-gray-400 opacity-80 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-500';
        }

        const title = (lesson.title || '').toLowerCase();
        const focus = (lesson.focus || '').toLowerCase();
        const text = title + ' ' + focus;

        if (text.includes('jump') || text.includes('pole') || text.includes('course')) return 'bg-orange-50 border-orange-100 text-orange-700 dark:bg-orange-900/30 dark:border-orange-800 dark:text-orange-400'; // Jump
        if (text.includes('flat') || text.includes('dressage')) return 'bg-sky-50 border-sky-100 text-sky-700 dark:bg-sky-900/30 dark:border-sky-800 dark:text-sky-400'; // Flat
        
        switch(lesson.type) {
            case 'Private': return 'bg-indigo-50 border-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:border-indigo-800 dark:text-indigo-400';
            case 'Group': return 'bg-emerald-50 border-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:border-emerald-800 dark:text-emerald-400';
            case 'Clinic': return 'bg-purple-50 border-purple-100 text-purple-700 dark:bg-purple-900/30 dark:border-purple-800 dark:text-purple-400';
            case 'Competition': return 'bg-amber-50 border-amber-100 text-amber-700 dark:bg-amber-900/30 dark:border-amber-800 dark:text-amber-400';
            case 'Arena Rent': return 'bg-gray-100 border-gray-200 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300';
            default: return 'bg-gray-50 border-gray-200 text-gray-700 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300';
        }
    };

    const handleEdit = (lesson, e) => {
        if (e) e.stopPropagation(); // Prevent triggering cell click if any
        if (readOnly) return; // Prevent edit if read-only

        const d = safeDate(lesson.date);
        const dateStr = d.toISOString().split('T')[0];
        const timeStr = lesson.time || d.toTimeString().slice(0, 5); // Use explicit time if available, else extract from Date
        
        const outcomes = lesson.outcomes || {};
        
        setFormData({ 
            ...lesson, 
            date: dateStr, 
            time: timeStr, 
            timeEnd: lesson.timeEnd || '',
            student: lesson.student || '', 
            horse: lesson.horse || '', 
            attendees: lesson.attendees || [], 
            isRecurring: false, 
            recurrenceWeeks: 4, 
            comment: lesson.comment || '',
            focus: lesson.focus || '',
            equipment: lesson.equipment || '',
            outcomes: outcomes 
        });
        
        setEditingId(lesson.id);
        
        // Smart detection for manual fields
        setIsInstructorManual(lesson.instructor && !staff.some(s => s.name === lesson.instructor));
        setIsStudentManual(lesson.student && !students.some(s => s.name === lesson.student));
        setIsHorseManual(lesson.horse && !horses.some(h => h.name === lesson.horse));
        
        // Pre-fill feedback if a single student is selected (Private)
        if (lesson.student && outcomes[lesson.student]) {
            setFeedback(outcomes[lesson.student]);
        } else {
            setFeedback({ achievement: '', note: '' });
        }
        
        setFeedbackStudent(lesson.student || '');
        setIsModalOpen(true);
    };

    const handleAdd = (date = null) => {
        if (readOnly) return; // Prevent add if read-only
        const d = date ? new Date(date) : new Date();
        const dateStr = d.toLocaleDateString('en-CA');
        setFormData({ title: '', date: dateStr, time: '09:00', timeEnd: '', instructor: '', type: 'Private', location: 'Main Arena', student: '', horse: '', attendees: [], isRecurring: false, recurrenceWeeks: 4, comment: '', focus: '', equipment: '', outcomes: {} });
        setEditingId(null);
        setAttendeeInput('');
        setAttendeeHorse('');
        setIsInstructorManual(false);
        setIsStudentManual(false);
        setIsHorseManual(false);
        setFeedback({ achievement: '', note: '' }); 
        setFeedbackStudent('');
        setIsModalOpen(true);
    };

    const addAttendee = () => {
        if(!attendeeInput) return;
        setFormData(prev => ({
            ...prev,
            attendees: [...(prev.attendees || []), { student: attendeeInput, horse: attendeeHorse }]
        }));
        setAttendeeInput('');
        setAttendeeHorse('');
    };

    const removeAttendee = (index) => {
        setFormData(prev => ({
            ...prev,
            attendees: (prev.attendees || []).filter((_, i) => i !== index)
        }));
    };

    const changeMonth = (offset) => {
        const newDate = new Date(currentDate);
        newDate.setMonth(newDate.getMonth() + offset);
        setCurrentDate(newDate);
    };

    // Calendar Configuration based on Settings
    const startOffset = settings?.calendarStartDay === 'Monday' ? 1 : 0;
    const weekDays = startOffset === 1 
        ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] 
        : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    const startDay = monthStart.getDay(); // 0 (Sun) to 6 (Sat)
    
    // Calculate empty slots based on start day preference
    // Formula: (DayOfWeek - StartOffset + 7) % 7
    const emptySlots = (startDay - startOffset + 7) % 7;

    const renderCalendarDays = () => {
        const days = [];
        // Empty slots for previous month
        for (let i = 0; i < emptySlots; i++) {
            days.push(<div key={`empty-${i}`} className="bg-gray-50 dark:bg-slate-900 border border-gray-100 dark:border-slate-800 min-h-[100px]"></div>);
        }
        
        // Days of current month
        for (let i = 1; i <= daysInMonth; i++) {
            const currentDayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
            const dayLessons = lessons.filter(l => {
                const ld = safeDate(l.date);
                return ld.getDate() === i && ld.getMonth() === currentDate.getMonth() && ld.getFullYear() === currentDate.getFullYear();
            }).sort((a,b) => safeDate(a.date) - safeDate(b.date));
            const isToday = new Date().toDateString() === currentDayDate.toDateString();

            days.push(
                <div key={i} className={`border border-gray-100 dark:border-slate-700 min-h-[100px] p-1 relative group hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors ${isToday ? 'bg-indigo-50/30 dark:bg-indigo-900/10' : 'bg-white dark:bg-slate-800'}`} onClick={() => handleAdd(currentDayDate)}>
                    <div className="flex justify-between items-start mb-1">
                        <span className={`text-sm font-semibold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white' : 'text-gray-700 dark:text-slate-300'}`}>{i}</span>
                        {!readOnly && <button onClick={(e) => { e.stopPropagation(); handleAdd(currentDayDate); }} className="opacity-0 group-hover:opacity-100 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded p-0.5"><Plus className="w-3 h-3" /></button>}
                    </div>
                    <div className="space-y-1">
                        {dayLessons.map(lesson => (
                            <div 
                                key={lesson.id} 
                                onClick={(e) => handleEdit(lesson, e)}
                                className={`text-xs p-1.5 rounded border ${!readOnly ? 'cursor-pointer' : ''} ${getCalendarColor(lesson)} ${lesson.status === 'Cancelled' ? 'line-through decoration-gray-400' : ''}`}
                            >
                                <div className="flex justify-between items-center font-bold border-b border-black/5 dark:border-white/5 pb-0.5 mb-0.5">
                                    <span className={lesson.status === 'Cancelled' ? 'no-underline' : ''}>
                                        {lesson.time || safeDate(lesson.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                        {lesson.timeEnd ? ` - ${lesson.timeEnd}` : ''}
                                    </span>
                                    {lesson.status === 'Pending' && <span className="text-[9px] bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 px-1 rounded no-underline">Req</span>}
                                    {lesson.status === 'Cancelled' && <span className="text-[9px] bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-1 rounded font-bold no-underline">Cancelled</span>}
                                </div>
                                
                                <div className="truncate font-medium">{lesson.title}</div>
                                
                                {lesson.instructor && (
                                    <div className="flex items-center truncate text-[10px] opacity-90 mt-0.5">
                                        <User className="w-3 h-3 mr-1 inline-block flex-shrink-0" /> {lesson.instructor}
                                    </div>
                                )}
                                
                                {/* Display Logic for Private Lesson */}
                                {(lesson.student || lesson.horse) && (
                                    <div className="flex items-center truncate text-[10px] opacity-90 mt-0.5">
                                        <Horse className="w-3 h-3 mr-1 inline-block flex-shrink-0" /> 
                                        {lesson.student}
                                        {lesson.student && lesson.horse && ' / '}
                                        {lesson.horse}
                                    </div>
                                )}

                                {/* Display Logic for Group Lesson Attendees */}
                                {lesson.attendees && lesson.attendees.length > 0 && (
                                    <div className="mt-1 space-y-0.5">
                                        {lesson.attendees.map((att, idx) => (
                                             <div key={idx} className="flex items-center truncate text-[10px] opacity-90">
                                                <Users className="w-3 h-3 mr-1 inline-block flex-shrink-0" />
                                                <span>{att.student}{att.horse ? ` / ${att.horse}` : ''}</span>
                                             </div>
                                        ))}
                                    </div>
                                )}

                                {lesson.location && (
                                    <div className="flex items-center truncate text-[10px] opacity-80 italic mt-0.5">
                                        <MapIcon className="w-3 h-3 mr-1 inline-block flex-shrink-0" /> {lesson.location}
                                    </div>
                                )}
                                {lesson.comment && (
                                    <div className="truncate text-[10px] text-gray-500 dark:text-gray-400 italic mt-0.5 border-t border-gray-200 dark:border-gray-600 pt-0.5">
                                        {lesson.comment}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        return days;
    };

    const renderListView = () => (
        <div className="divide-y divide-gray-100 dark:divide-slate-700">
            {lessons.sort((a,b) => safeDate(a.date) - safeDate(b.date)).map(lesson => (
                 <div key={lesson.id} className={`p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-slate-700 ${lesson.status === 'Cancelled' ? 'opacity-60 bg-gray-50 dark:bg-slate-800' : ''}`}>
                     <div className="flex items-center gap-4">
                        <div className="text-center w-20">
                            <div className="text-sm font-bold text-gray-900 dark:text-white">{safeDate(lesson.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</div>
                            <div className={`text-xs text-gray-500 dark:text-slate-400 ${lesson.status === 'Cancelled' ? 'line-through' : ''}`}>
                                {lesson.time || safeDate(lesson.date).toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'})}
                                {lesson.timeEnd ? ` - ${lesson.timeEnd}` : ''}
                            </div>
                        </div>
                        <div>
                            <h4 className={`font-medium text-gray-900 dark:text-white ${lesson.status === 'Cancelled' ? 'line-through decoration-gray-400' : ''}`}>
                                {lesson.title}
                                {lesson.status === 'Pending' && <span className="ml-2 text-xs bg-yellow-200 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-1.5 py-0.5 rounded no-underline">Req</span>}
                                {lesson.status === 'Cancelled' && <span className="ml-2 text-xs bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-1.5 py-0.5 rounded no-underline inline-block">Cancelled</span>}
                            </h4>
                            
                            {/* Trainer */}
                            {lesson.instructor && (
                                <div className="flex items-center text-sm text-gray-600 dark:text-slate-300 mt-0.5">
                                    <User className="w-3 h-3 mr-1.5 flex-shrink-0" /> {lesson.instructor}
                                </div>
                            )}

                            {/* Private Lesson Details */}
                            {(lesson.student || lesson.horse) && (
                                <div className="flex items-center text-sm text-gray-600 dark:text-slate-300 mt-0.5">
                                    <Horse className="w-3 h-3 mr-1.5 flex-shrink-0" /> 
                                    {lesson.student}
                                    {lesson.student && lesson.horse && ' / '}
                                    {lesson.horse}
                                </div>
                            )}

                            {/* Group Lesson Details */}
                            {lesson.attendees && lesson.attendees.length > 0 && (
                                <div className="mt-1 space-y-0.5">
                                    {lesson.attendees.map((att, idx) => (
                                         <div key={idx} className="flex items-center text-sm text-gray-600 dark:text-slate-300">
                                            <Users className="w-3 h-3 mr-1.5 flex-shrink-0" />
                                            <span>{att.student}{att.horse ? ` / ${att.horse}` : ''}</span>
                                         </div>
                                    ))}
                                </div>
                            )}

                            {/* Arena/Location */}
                            {lesson.location && (
                                <div className="flex items-center text-sm text-gray-500 dark:text-slate-400 italic mt-0.5">
                                    <MapIcon className="w-3 h-3 mr-1.5 flex-shrink-0" /> {lesson.location}
                                </div>
                            )}
                            {lesson.comment && (
                                <div className="text-xs text-gray-500 dark:text-slate-400 italic mt-1 bg-gray-50 dark:bg-slate-700 p-1 rounded inline-block">
                                    {lesson.comment}
                                </div>
                            )}
                        </div>
                     </div>
                     {!readOnly && (
                         <div className="flex items-center gap-3">
                            <Badge type={getSmartLessonColor(lesson)}>{lesson.type}</Badge>
                            <button onClick={(e) => handleEdit(lesson, e)} className="p-1 text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400"><Edit2 className="w-4 h-4" /></button>
                            <button onClick={() => onDeleteLesson(lesson.id)} className="p-1 text-gray-400 hover:text-rose-600 dark:hover:text-rose-400"><Trash2 className="w-4 h-4" /></button>
                         </div>
                     )}
                     {readOnly && (
                         <div className="flex items-center gap-3">
                            <Badge type={getSmartLessonColor(lesson)}>{lesson.type}</Badge>
                         </div>
                     )}
                </div>
            ))}
            {lessons.length === 0 && <div className="p-8 text-center text-gray-500 dark:text-slate-400">No lessons scheduled.</div>}
        </div>
    );

    return (
        <div className="space-y-4">
             <div className="flex justify-between items-center mb-4">
                <div className="flex items-center space-x-4">
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
                        {currentDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' })}
                    </h2>
                    <div className="flex space-x-1">
                        <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-600 dark:text-slate-300 rounded"><ChevronLeft className="w-5 h-5" /></button>
                        <button onClick={() => setCurrentDate(new Date())} className="px-2 py-1 text-xs font-medium hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-600 dark:text-slate-300 rounded">Today</button>
                        <button onClick={() => changeMonth(1)} className="p-1 hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-600 dark:text-slate-300 rounded"><ChevronRight className="w-5 h-5" /></button>
                    </div>
                </div>
                <div className="flex space-x-2">
                    <div className="flex bg-gray-100 dark:bg-slate-700 p-1 rounded-lg">
                        <button 
                            onClick={() => setViewMode('month')} 
                            className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${viewMode === 'month' ? 'bg-white dark:bg-slate-600 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200'}`}
                        >
                            Month
                        </button>
                        <button 
                            onClick={() => setViewMode('list')} 
                            className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${viewMode === 'list' ? 'bg-white dark:bg-slate-600 shadow-sm text-gray-900 dark:text-white' : 'text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200'}`}
                        >
                            List
                        </button>
                    </div>
                    {!readOnly && <Button onClick={() => handleAdd()} icon={Plus}>Add Lesson</Button>}
                </div>
             </div>
             
             <Card className="overflow-hidden">
                {viewMode === 'month' ? (
                    <>
                        <div className="grid grid-cols-7 bg-gray-50 dark:bg-slate-700 border-b border-gray-200 dark:border-slate-600 text-center py-2">
                            {weekDays.map(d => (
                                <div key={d} className="text-xs font-bold text-gray-500 dark:text-slate-300 uppercase">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 auto-rows-auto bg-gray-50 dark:bg-slate-700 border-l border-t border-gray-200 dark:border-slate-600">
                            {renderCalendarDays()}
                        </div>
                    </>
                ) : (
                    renderListView()
                )}
             </Card>

             <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? "Edit Lesson" : "New Lesson"}>
                 <form onSubmit={handleSubmit}>
                     <Input label="Title/Description" value={formData.title || ''} onChange={e => setFormData({...formData, title: e.target.value})} required />
                     <Select label="Type" value={formData.type || 'Private'} onChange={e => setFormData({...formData, type: e.target.value})}>
                         <option>Private</option><option>Group</option><option>Clinic</option><option>Competition</option><option>Arena Rent</option>
                     </Select>
                     
                     {['Group', 'Clinic', 'Competition'].includes(formData.type) ? (
                        <div className="mb-4 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg border border-gray-200 dark:border-slate-600">
                            <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Participants</label>
                            <div className="space-y-2 mb-3">
                                {(formData.attendees || []).map((att, i) => (
                                    <div key={i} className="flex justify-between items-center bg-white dark:bg-slate-600 p-2 rounded border border-gray-200 dark:border-slate-500 text-sm">
                                        <span className="dark:text-white">{att.student} {att.horse && <span className="text-gray-500 dark:text-slate-400">({att.horse})</span>}</span>
                                        <button type="button" onClick={() => removeAttendee(i)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded p-1"><XIcon className="w-3 h-3"/></button>
                                    </div>
                                ))}
                                {(formData.attendees || []).length === 0 && <p className="text-xs text-gray-400 italic">No participants added.</p>}
                            </div>
                            <div className="flex flex-col gap-2 mb-2">
                                <div className="flex gap-2">
                                    <select 
                                        className="w-1/3 px-2 py-1 text-sm border border-gray-300 dark:border-slate-600 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        onChange={(e) => { if(e.target.value) setAttendeeInput(e.target.value); }}
                                        value=""
                                    >
                                        <option value="">Select Student...</option>
                                        {students.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                    <input 
                                        className="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-slate-600 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        placeholder="Name (Student or Guest)"
                                        value={attendeeInput}
                                        onChange={(e) => setAttendeeInput(e.target.value)}
                                    />
                                </div>
                                <div className="flex gap-2">
                                    <select
                                        className="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-slate-600 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        value={attendeeHorse}
                                        onChange={(e) => setAttendeeHorse(e.target.value)}
                                    >
                                        <option value="">-- Assign Horse (Optional) --</option>
                                        {horses.map(h => <option key={h.id} value={h.name}>{h.name}</option>)}
                                    </select>
                                    <Button type="button" onClick={addAttendee} size="sm" icon={Plus}>Add</Button>
                                </div>
                            </div>
                        </div>
                     ) : (
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Student</label>
                            {!isStudentManual ? (
                                <select 
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                    value={formData.student}
                                    onChange={(e) => {
                                        if (e.target.value === 'custom_student_val') {
                                            setIsStudentManual(true);
                                            setFormData({...formData, student: ''});
                                        } else {
                                            setFormData({...formData, student: e.target.value});
                                        }
                                    }}
                                >
                                    <option value="">-- Select Student --</option>
                                    {students.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    <option value="custom_student_val">+ Custom / External...</option>
                                </select>
                            ) : (
                                <div className="flex gap-2">
                                    <input 
                                        className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        placeholder="Enter student name"
                                        value={formData.student}
                                        onChange={(e) => setFormData({...formData, student: e.target.value})}
                                        autoFocus
                                    />
                                    <Button variant="secondary" onClick={() => setIsStudentManual(false)}>Cancel</Button>
                                </div>
                            )}
                        </div>
                     )}
                     
                     {/* Horse selection for single lessons */}
                     {!['Group', 'Clinic', 'Competition'].includes(formData.type) && (
                         <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Horse</label>
                            {!isHorseManual ? (
                                <select 
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                    value={formData.horse}
                                    onChange={(e) => {
                                        if (e.target.value === 'custom_horse_val') {
                                            setIsHorseManual(true);
                                            setFormData({...formData, horse: ''});
                                        } else {
                                            setFormData({...formData, horse: e.target.value});
                                        }
                                    }}
                                >
                                    <option value="">-- Select Horse --</option>
                                    {horses.map(h => <option key={h.id} value={h.name}>{h.name}</option>)}
                                    <option value="custom_horse_val">+ Custom / External...</option>
                                </select>
                            ) : (
                                <div className="flex gap-2">
                                    <input 
                                        className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        placeholder="Enter horse name"
                                        value={formData.horse}
                                        onChange={(e) => setFormData({...formData, horse: e.target.value})}
                                        autoFocus
                                    />
                                    <Button variant="secondary" onClick={() => setIsHorseManual(false)}>Cancel</Button>
                                </div>
                            )}
                         </div>
                     )}

                     <div className="grid grid-cols-3 gap-4">
                        <Input type="date" label="Date" value={formData.date || ''} onChange={e => setFormData({...formData, date: e.target.value})} required />
                        <Input type="time" label="Start" value={formData.time || ''} onChange={e => setFormData({...formData, time: e.target.value})} required />
                        <Input type="time" label="End (Opt)" value={formData.timeEnd || ''} onChange={e => setFormData({...formData, timeEnd: e.target.value})} />
                     </div>

                     <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Instructor</label>
                        {!isInstructorManual ? (
                            <select 
                                className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                value={formData.instructor}
                                onChange={(e) => {
                                    if (e.target.value === 'custom_instructor_val') {
                                        setIsInstructorManual(true);
                                        setFormData({...formData, instructor: ''});
                                    } else {
                                        setFormData({...formData, instructor: e.target.value});
                                    }
                                }}
                            >
                                <option value="">-- Select Instructor --</option>
                                {staff && staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                <option value="custom_instructor_val">+ External / Manual Entry...</option>
                            </select>
                        ) : (
                            <div className="flex gap-2">
                                <input 
                                    className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                    placeholder="Enter instructor name"
                                    value={formData.instructor}
                                    onChange={(e) => setFormData({...formData, instructor: e.target.value})}
                                    autoFocus
                                />
                                <Button variant="secondary" onClick={() => setIsInstructorManual(false)}>Cancel</Button>
                            </div>
                        )}
                     </div>

                     <div className="grid grid-cols-2 gap-4">
                        <Input label="Location" value={formData.location || ''} onChange={e => setFormData({...formData, location: e.target.value})} />
                        <Input label="Equipment / Prep" placeholder="e.g. Body protector, spurs" value={formData.equipment || ''} onChange={e => setFormData({...formData, equipment: e.target.value})} />
                     </div>
                     
                     <div className="mb-4">
                        <Input label="Lesson Focus / Goal" placeholder="e.g. Jumping lines, Flatwork basics" value={formData.focus || ''} onChange={e => setFormData({...formData, focus: e.target.value})} />
                     </div>

                     <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Comment (Optional)</label>
                        <textarea
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            rows="2"
                            value={formData.comment || ''}
                            onChange={e => setFormData({...formData, comment: e.target.value})}
                        />
                     </div>

                     {!editingId && (
                         <div className="bg-indigo-50 dark:bg-indigo-900/30 p-3 rounded-lg border border-indigo-100 dark:border-indigo-800 mb-4">
                             <label className="flex items-center space-x-2">
                                 <input 
                                     type="checkbox" 
                                     className="rounded text-indigo-600 focus:ring-indigo-500"
                                     checked={formData.isRecurring}
                                     onChange={(e) => setFormData({...formData, isRecurring: e.target.checked})}
                                 />
                                 <span className="text-sm font-medium text-gray-900 dark:text-white">Repeat Weekly?</span>
                             </label>
                             {formData.isRecurring && (
                                 <div className="mt-2 pl-6">
                                     <label className="block text-xs text-gray-500 dark:text-slate-400 mb-1">For how many weeks?</label>
                                     <input 
                                         type="number" 
                                         min="1" max="52"
                                         className="w-20 px-2 py-1 text-sm border border-gray-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                         value={formData.recurrenceWeeks || 1}
                                         onChange={(e) => setFormData({...formData, recurrenceWeeks: parseInt(e.target.value) || 1})}
                                     />
                                 </div>
                             )}
                         </div>
                     )}

                     {editingId && (
                         <Select label="Status" value={formData.status || ''} onChange={e => setFormData({...formData, status: e.target.value})}>
                             <option value="">Scheduled</option>
                             <option value="Pending">Pending Approval</option>
                             <option value="Cancelled">Cancelled</option>
                         </Select>
                     )}
                     
                     {editingId && (formData.student || (formData.attendees && formData.attendees.length > 0)) && (
                        <div className="mt-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-100 dark:border-green-800">
                            <h4 className="font-bold text-gray-900 dark:text-white text-sm mb-2">Lesson Outcome (Updates Student Profile)</h4>
                            
                            {['Group', 'Clinic', 'Competition'].includes(formData.type) && (
                                <div className="mb-3">
                                    <label className="block text-xs font-medium text-gray-700 dark:text-slate-300 mb-1">Select Student to Update</label>
                                    <select 
                                        className="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-slate-600 rounded focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        value={feedbackStudent}
                                        onChange={e => {
                                            const s = e.target.value;
                                            setFeedbackStudent(s);
                                            // Load existing feedback for this student if it exists
                                            if (formData.outcomes && formData.outcomes[s]) {
                                                setFeedback(formData.outcomes[s]);
                                            } else {
                                                setFeedback({ achievement: '', note: '' });
                                            }
                                        }}
                                    >
                                        <option value="">-- Select Student --</option>
                                        {(formData.attendees || []).map((att, i) => (
                                            <option key={i} value={att.student}>{att.student}</option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            <div className="space-y-3">
                                <Input 
                                    label="New Achievement" 
                                    placeholder="e.g. Canter transition" 
                                    value={feedback.achievement || ''} 
                                    onChange={e => setFeedback({...feedback, achievement: e.target.value})} 
                                />
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Progress Note</label>
                                    <textarea
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                        rows="2"
                                        placeholder="e.g. Great balance today..."
                                        value={feedback.note || ''}
                                        onChange={e => setFeedback({...feedback, note: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>
                     )}

                     <div className="flex justify-end pt-4"><Button type="submit">Save</Button></div>
                 </form>
             </Modal>
        </div>
    );
};

// ... InventoryModule, TasksModule, ParentCard, ParentsModule, StaffCard, StaffListModule, SettingsSwitch, SettingsModule, MessageCenterModule ...

const InventoryModule = ({ inventory, onAddItem, onUpdateItem, onDeleteItem }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({ name: '', category: 'Feed', quantity: 0, unit: 'bags', reorderPoint: 5 });
    const [editingId, setEditingId] = useState(null);
    const [isCustomCategory, setIsCustomCategory] = useState(false);
    const [activeTab, setActiveTab] = useState('All');
    
    // Get unique categories from existing inventory + defaults
    const defaultCategories = ['Feed', 'Bedding', 'Medical', 'Tack', 'Equipment'];
    const existingCategories = [...new Set(inventory.map(i => i.category).filter(Boolean))];
    const availableCategories = [...new Set([...defaultCategories, ...existingCategories])].sort();

    const handleSubmit = (e) => {
        e.preventDefault();
        // If editing, use editingId, else add
        const dataToSave = { ...formData };
        if(editingId) onUpdateItem(editingId, dataToSave);
        else onAddItem(dataToSave);
        setIsModalOpen(false);
    };

    const handleOpenModal = (item = null) => {
        if (item) {
            setEditingId(item.id);
            setFormData(item);
            setIsCustomCategory(false); 
        } else {
            setEditingId(null);
            setFormData({ name: '', category: 'Feed', quantity: 0, unit: 'bags', reorderPoint: 5 });
            setIsCustomCategory(false);
        }
        setIsModalOpen(true);
    }

    // Grouping for display - Safe check for inventory
    const safeInventory = inventory || [];
    const groupedInventory = useMemo(() => {
        return safeInventory.reduce((acc, item) => {
            const cat = item.category || 'Uncategorized';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(item);
            return acc;
        }, {});
    }, [safeInventory]);

    const tabs = ['All', ...Object.keys(groupedInventory).sort()];

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Inventory</h2>
                <Button onClick={() => handleOpenModal()} icon={Plus}>Add Item</Button>
            </div>
            <div className="flex space-x-2 border-b border-gray-200 dark:border-slate-700 overflow-x-auto no-scrollbar">
                {tabs.map(tab => (
                    <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`px-4 py-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${
                            activeTab === tab
                                ? 'border-indigo-600 text-indigo-600 dark:text-indigo-400'
                                : 'border-transparent text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200 hover:border-gray-300'
                        }`}
                    >
                        {tab}
                    </button>
                ))}
            </div>
            
            {Object.keys(groupedInventory).length === 0 && <div className="p-8 text-center text-gray-500 bg-gray-50 dark:bg-slate-700 rounded-lg">No inventory items found.</div>}
            
            {activeTab === 'All' ? (
                Object.keys(groupedInventory).sort().map(category => (
                    <div key={category} className="mb-6">
                        <h3 className="text-lg font-semibold text-gray-700 dark:text-slate-300 mb-3 px-1 border-b border-gray-200 dark:border-slate-700 pb-2">{category}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {groupedInventory[category].map(item => {
                                const isLowStock = Number(item.quantity) <= Number(item.reorderPoint);
                                return (
                                    <Card key={item.id} className={`p-5 flex justify-between items-center ${isLowStock ? 'border-l-4 border-l-rose-500' : ''}`}>
                                        <div>
                                            <h3 className="font-bold text-gray-900 dark:text-white">{item.name}</h3>
                                            <p className="text-sm text-gray-500 dark:text-slate-400">Reorder at {item.reorderPoint} {item.unit}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-2xl font-bold ${isLowStock ? 'text-rose-600 dark:text-rose-400' : 'text-indigo-600 dark:text-indigo-400'}`}>
                                                {item.quantity} <span className="text-sm font-normal text-gray-500 dark:text-slate-400">{item.unit}</span>
                                            </div>
                                            <div className="flex justify-end gap-2 mt-2">
                                                <button onClick={() => handleOpenModal(item)} className="text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400"><Edit2 className="w-4 h-4" /></button>
                                                <button onClick={() => onDeleteItem(item.id)} className="text-gray-400 hover:text-rose-600 dark:hover:text-rose-400"><Trash2 className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    </div>
                ))
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                    {groupedInventory[activeTab] && groupedInventory[activeTab].map(item => {
                        const isLowStock = Number(item.quantity) <= Number(item.reorderPoint);
                        return (
                            <Card key={item.id} className={`p-5 flex justify-between items-center ${isLowStock ? 'border-l-4 border-l-rose-500' : ''}`}>
                                <div>
                                    <h3 className="font-bold text-gray-900 dark:text-white">{item.name}</h3>
                                    <p className="text-sm text-gray-500 dark:text-slate-400">Reorder at {item.reorderPoint} {item.unit}</p>
                                </div>
                                <div className="text-right">
                                    <div className={`text-2xl font-bold ${isLowStock ? 'text-rose-600 dark:text-rose-400' : 'text-indigo-600 dark:text-indigo-400'}`}>
                                        {item.quantity} <span className="text-sm font-normal text-gray-500 dark:text-slate-400">{item.unit}</span>
                                    </div>
                                    <div className="flex justify-end gap-2 mt-2">
                                        <button onClick={() => handleOpenModal(item)} className="text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400"><Edit2 className="w-4 h-4" /></button>
                                        <button onClick={() => onDeleteItem(item.id)} className="text-gray-400 hover:text-rose-600 dark:hover:text-rose-400"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            </Card>
                        );
                    })}
                    {!groupedInventory[activeTab] && <div className="col-span-full text-center py-8 text-gray-500 dark:text-slate-400">Category empty or removed.</div>}
                </div>
            )}
            
            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? "Edit Item" : "New Item"}>
                <form onSubmit={handleSubmit}>
                    <Input label="Item Name" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                    
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Category</label>
                        {!isCustomCategory ? (
                            <select 
                                className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                value={formData.category}
                                onChange={(e) => {
                                    if (e.target.value === 'custom_option_value') {
                                        setIsCustomCategory(true);
                                        setFormData({...formData, category: ''});
                                    } else {
                                        setFormData({...formData, category: e.target.value});
                                    }
                                }}
                            >
                                {availableCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                <option value="custom_option_value">+ Add New Category...</option>
                            </select>
                        ) : (
                            <div className="flex gap-2">
                                <input 
                                    className="flex-1 px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                    placeholder="Enter category name"
                                    value={formData.category}
                                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    autoFocus
                                />
                                <Button variant="secondary" onClick={() => setIsCustomCategory(false)}>Cancel</Button>
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                        <Input type="number" label="Quantity" value={formData.quantity} onChange={e => setFormData({...formData, quantity: e.target.value})} />
                        <Input label="Unit" value={formData.unit} onChange={e => setFormData({...formData, unit: e.target.value})} />
                        <Input type="number" label="Reorder Pt" value={formData.reorderPoint} onChange={e => setFormData({...formData, reorderPoint: e.target.value})} />
                    </div>
                    <div className="flex justify-end pt-4"><Button type="submit">Save</Button></div>
                </form>
            </Modal>
        </div>
    );
};

const TasksModule = ({ tasks, staff, onAddTask, onUpdateTask, onDeleteTask }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({ title: '', description: '', assignedTo: '', priority: 'Medium', status: 'Pending', dueDate: '' });
    const [editingId, setEditingId] = useState(null);
    const [filterTab, setFilterTab] = useState('Open'); // Open, Coming, Ended

    const handleSubmit = (e) => {
        e.preventDefault();
        if (editingId) {
            onUpdateTask(editingId, formData);
        } else {
            onAddTask(formData);
        }
        setIsModalOpen(false);
    };

    const handleOpenModal = (task = null) => {
        if (task) {
            setEditingId(task.id);
            setFormData({
                title: task.title || '',
                description: task.description || '',
                assignedTo: task.assignedTo || '',
                priority: task.priority || 'Medium',
                status: task.status || 'Pending',
                dueDate: task.dueDate || ''
            });
        } else {
            setEditingId(null);
            setFormData({ title: '', description: '', assignedTo: '', priority: 'Medium', status: 'Pending', dueDate: '' });
        }
        setIsModalOpen(true);
    };

    const getFilteredTasks = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        return tasks.filter(task => {
            const isCompleted = task.status === 'Completed';
            const taskDate = task.dueDate ? new Date(task.dueDate) : null;
            
            if (taskDate) taskDate.setHours(0,0,0,0);

            if (filterTab === 'Ended') {
                return isCompleted;
            }
            if (isCompleted) return false;

            if (filterTab === 'Coming') {
                return taskDate && taskDate > today;
            }
            return !taskDate || taskDate <= today;
        });
    };

    const filteredTasks = getFilteredTasks();

    return (
        <div className="space-y-6">
             <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Tasks</h2>
                <Button onClick={() => handleOpenModal()} icon={Plus}>Add Task</Button>
            </div>

            {/* Tabs */}
            <div className="flex space-x-1 bg-gray-100 dark:bg-slate-700 p-1 rounded-lg w-fit">
                {['Open', 'Coming', 'Ended'].map(tab => (
                    <button
                        key={tab}
                        onClick={() => setFilterTab(tab)}
                        className={`px-4 py-2 text-sm font-medium rounded-md transition-colors ${
                            filterTab === tab 
                            ? 'bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-400 shadow-sm' 
                            : 'text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-200'
                        }`}
                    >
                        {tab === 'Coming' ? 'Upcoming' : tab === 'Ended' ? 'Completed' : 'Open'}
                    </button>
                ))}
            </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 {filteredTasks.map(task => (
                     <Card key={task.id} className={`p-4 border-l-4 ${task.status === 'Completed' ? 'border-l-green-500 opacity-75' : 'border-l-indigo-400'}`}>
                         <div className="flex justify-between items-start mb-2">
                             <h4 className={`font-bold text-gray-900 dark:text-white ${task.status === 'Completed' ? 'line-through' : ''}`}>{task.title}</h4>
                             <Badge type={task.priority === 'High' ? 'danger' : task.priority === 'Low' ? 'success' : 'warning'}>{task.priority}</Badge>
                         </div>
                         <p className="text-sm text-gray-600 dark:text-slate-300 mb-3">{task.description}</p>
                         
                         <div className="flex flex-col gap-2 mt-4 pt-3 border-t border-gray-100 dark:border-slate-700">
                             <div className="flex justify-between text-xs text-gray-500 dark:text-slate-400">
                                <span>Assigned: {task.assignedTo || 'Unassigned'}</span>
                                {task.dueDate && <span>Due: {new Date(task.dueDate).toLocaleDateString()}</span>}
                             </div>
                             
                             <div className="flex justify-between items-center pt-2">
                                <div className="flex gap-2">
                                     <button onClick={() => handleOpenModal(task)} className="text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400"><Edit2 className="w-4 h-4" /></button>
                                     <button onClick={() => onDeleteTask(task.id)} className="text-gray-400 hover:text-rose-700 dark:hover:text-rose-400"><Trash2 className="w-4 h-4" /></button>
                                </div>
                                {task.status !== 'Completed' ? (
                                    <button 
                                        onClick={() => onUpdateTask(task.id, { ...task, status: 'Completed' })}
                                        className="text-xs font-medium text-emerald-600 hover:text-emerald-800 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded"
                                    >
                                        Mark Done
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => onUpdateTask(task.id, { ...task, status: 'Pending' })}
                                        className="text-xs font-medium text-gray-500 hover:text-gray-700 bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded"
                                    >
                                        Reopen
                                    </button>
                                )}
                             </div>
                         </div>
                     </Card>
                 ))}
                 {filteredTasks.length === 0 && <div className="col-span-full text-center py-8 text-gray-500 bg-gray-50 dark:bg-slate-700 rounded-lg">No {filterTab.toLowerCase()} tasks found.</div>}
             </div>

             <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? "Edit Task" : "New Task"}>
                 <form onSubmit={handleSubmit}>
                     <Input label="Title" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} required />
                     <Input label="Description" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
                     <div className="grid grid-cols-2 gap-4">
                        <Input type="date" label="Due Date" value={formData.dueDate} onChange={e => setFormData({...formData, dueDate: e.target.value})} />
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Assigned To</label>
                             <select 
                                className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                                value={formData.assignedTo}
                                onChange={e => setFormData({...formData, assignedTo: e.target.value})}
                            >
                                <option value="">Unassigned</option>
                                {staff && staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                            </select>
                        </div>
                     </div>
                     <div className="grid grid-cols-2 gap-4">
                        <Select label="Priority" value={formData.priority} onChange={e => setFormData({...formData, priority: e.target.value})}><option>Low</option><option>Medium</option><option>High</option></Select>
                        <Select label="Status" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                            <option>Pending</option>
                            <option>In Progress</option>
                            <option>Completed</option>
                        </Select>
                     </div>
                     <div className="flex justify-end pt-4"><Button type="submit">Save Task</Button></div>
                 </form>
             </Modal>
        </div>
    );
};

const ParentCard = ({ p, students, onEdit, onDelete }) => {
  // Find children linked to this parent
  const children = students ? students.filter(s => s.parentId === p.id) : [];

  return (
    <Card className="p-5 flex flex-col gap-3 h-full">
        <div className="flex justify-between items-start">
            <div className="flex items-center gap-3">
                 <div className="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center text-purple-600 dark:text-purple-400 flex-shrink-0">
                    <Users className="w-5 h-5"/>
                </div>
                <div>
                    <h3 className="text-lg font-bold leading-tight text-gray-900 dark:text-white">{p.name}</h3>
                    <div className="flex flex-wrap gap-2 mt-1">
                        <Badge type="purple">Parent</Badge>
                        {p.dob && <span className="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 px-1.5 py-0.5 rounded border border-gray-200 dark:border-slate-600">Born: {safeDate(p.dob).toLocaleDateString('en-GB')}</span>}
                    </div>
                </div>
            </div>
            <div className="flex gap-1 flex-shrink-0">
                <button onClick={onEdit} className="p-1 text-gray-400 hover:text-indigo-600 rounded hover:bg-gray-100 dark:hover:bg-slate-700"><Settings className="w-4 h-4"/></button>
                <button onClick={onDelete} className="p-1 text-gray-400 hover:text-rose-500 rounded hover:bg-gray-100 dark:hover:bg-slate-700"><XIcon className="w-4 h-4"/></button>
            </div>
        </div>

        {/* Contact Info */}
        <div className="text-sm text-gray-600 dark:text-slate-400 space-y-1.5 bg-gray-50 dark:bg-slate-700 p-2.5 rounded-lg border border-gray-100 dark:border-slate-600">
            {p.email && <div className="flex items-center gap-2 truncate"><Mail className="w-3.5 h-3.5 text-gray-400"/> {p.email}</div>}
            {p.phone && <div className="flex items-center gap-2 truncate"><Phone className="w-3.5 h-3.5 text-gray-400"/> {p.phone}</div>}
            {p.address && <div className="flex items-center gap-2 truncate"><MapPin className="w-3.5 h-3.5 text-gray-400"/> {p.address}</div>}
            
            {/* Socials */}
            {p.instagram && <div className="flex items-center gap-2 truncate"><Instagram className="w-3.5 h-3.5 text-pink-500"/> {p.instagram}</div>}
            {p.facebook && <div className="flex items-center gap-2 truncate"><Facebook className="w-3.5 h-3.5 text-blue-600"/> {p.facebook}</div>}
            {p.whatsapp && <div className="flex items-center gap-2 truncate"><MessageCircle className="w-3.5 h-3.5 text-green-500"/> {p.whatsapp}</div>}

            {/* Children List */}
            {children.length > 0 && (
                <div className="pt-2 mt-2 border-t border-gray-200 dark:border-slate-600">
                    <span className="text-[10px] uppercase text-gray-400 font-bold block mb-1">Children</span>
                    <div className="space-y-1">
                        {children.map(c => (
                            <div key={c.id} className="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-medium text-xs">
                                <Baby className="w-3.5 h-3.5 flex-shrink-0"/> {c.name}
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {!p.email && !p.phone && !p.address && !p.instagram && !p.facebook && !p.whatsapp && children.length === 0 && <span className="text-xs text-gray-400 italic">No contact info</span>}
        </div>
    </Card>
  );
};

const ParentsModule = ({ parents, students, onAddParent, onUpdateParent, onDeleteParent }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({ name: '', email: '', phone: '', dob: '', address: '', instagram: '', facebook: '', whatsapp: '' });
    const [editingId, setEditingId] = useState(null);

    // --- Sorting State ---
    const [sortBy, setSortBy] = useState('name');

    const handleSubmit = (e) => {
        e.preventDefault();
        if(editingId) {
            onUpdateParent(editingId, formData);
        } else {
            onAddParent({ ...formData, createdAt: new Date().toISOString() });
        }
        setIsModalOpen(false);
    };

    const processedParents = useMemo(() => {
        let result = [...parents];
        result.sort((a, b) => {
            if (sortBy === 'name') return a.name.localeCompare(b.name);
            if (sortBy === 'newest') {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return dateB - dateA;
            }
            if (sortBy === 'oldest') {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return dateA - dateB;
            }
            return 0;
        });
        return result;
    }, [parents, sortBy]);

    return (
        <div className="space-y-6">
             <div className="flex flex-col gap-4">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Parents</h2>
                    <Button onClick={() => { setEditingId(null); setFormData({name: '', email: '', phone: '', dob: '', address: '', instagram: '', facebook: '', whatsapp: ''}); setIsModalOpen(true); }} icon={Plus}>Add Parent</Button>
                </div>

                {/* Controls Row */}
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white dark:bg-slate-800 p-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm">
                    <div className="flex-1 overflow-x-auto no-scrollbar w-full">
                        <div className="flex space-x-2 px-1">
                            <button className="px-3 py-1.5 text-xs font-medium rounded-lg whitespace-nowrap transition-colors border bg-indigo-600 text-white border-indigo-600 shadow-sm">
                                All
                            </button>
                        </div>
                    </div>
                    <div className="flex items-center space-x-2 pl-2 border-l border-gray-200 dark:border-slate-700 flex-shrink-0">
                        <span className="text-xs font-bold text-gray-400 uppercase">Sort:</span>
                        <select 
                            value={sortBy} 
                            onChange={(e) => setSortBy(e.target.value)}
                            className="text-sm border-none bg-transparent font-medium text-gray-700 dark:text-white focus:ring-0 cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400"
                        >
                            <option className="dark:bg-slate-800" value="name">Alphabetical (A-Z)</option>
                            <option className="dark:bg-slate-800" value="newest">Newest First</option>
                            <option className="dark:bg-slate-800" value="oldest">Oldest First</option>
                        </select>
                    </div>
                </div>
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 {processedParents.map(p => (
                     <ParentCard 
                        key={p.id} 
                        p={p} 
                        students={students}
                        onEdit={() => { setEditingId(p.id); setFormData(p); setIsModalOpen(true); }}
                        onDelete={() => onDeleteParent(p.id)}
                     />
                 ))}
                 {processedParents.length === 0 && <div className="col-span-full text-center py-12 text-gray-500 bg-gray-50 dark:bg-slate-700 rounded-lg border border-dashed border-gray-300 dark:border-slate-600">No parents found.</div>}
             </div>
             <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? "Edit Parent" : "New Parent"}>
                 <form onSubmit={handleSubmit}>
                     <Input label="Name" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} required />
                     <div className="grid grid-cols-2 gap-4">
                        <Input label="Email" value={formData.email || ''} onChange={e => setFormData({...formData, email: e.target.value})} required />
                        <Input label="Date of Birth" type="date" value={formData.dob || ''} onChange={e => setFormData({...formData, dob: e.target.value})} />
                     </div>
                     <Input label="Phone" value={formData.phone || ''} onChange={e => setFormData({...formData, phone: e.target.value})} />
                     <Input label="Address" value={formData.address || ''} onChange={e => setFormData({...formData, address: e.target.value})} />
                     
                     <div className="grid grid-cols-3 gap-3">
                        <Input label="Instagram" placeholder="@..." value={formData.instagram || ''} onChange={e=>setFormData({...formData, instagram:e.target.value})} />
                        <Input label="Facebook" placeholder="Name/URL" value={formData.facebook || ''} onChange={e=>setFormData({...formData, facebook:e.target.value})} />
                        <Input label="WhatsApp" placeholder="+1..." value={formData.whatsapp || ''} onChange={e=>setFormData({...formData, whatsapp:e.target.value})} />
                     </div>

                     <div className="flex justify-end pt-4"><Button type="submit">Save</Button></div>
                 </form>
             </Modal>
        </div>
    );
};

const StaffCard = ({ s, onEdit, onDelete }) => {
  const [isExpanded, setIsExpanded] = useState(false);

  return (
    <Card className="p-5 flex flex-col gap-3 h-full">
        <div className="flex justify-between items-start">
            <div className="flex items-center gap-3">
                 <div className="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center text-orange-600 dark:text-orange-400 flex-shrink-0">
                    <UserCog className="w-5 h-5"/>
                </div>
                <div>
                    <h3 className="text-lg font-bold leading-tight text-gray-900 dark:text-white">{s.name}</h3>
                    <div className="flex flex-wrap gap-2 mt-1">
                        <Badge type="blue">{s.role}</Badge>
                        {s.dob && <span className="text-[10px] bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 px-1.5 py-0.5 rounded border border-gray-200 dark:border-slate-600">Born: {safeDate(s.dob).toLocaleDateString('en-GB')}</span>}
                    </div>
                </div>
            </div>
            <div className="flex gap-1 flex-shrink-0">
                <button onClick={onEdit} className="p-1 text-gray-400 hover:text-indigo-600 rounded hover:bg-gray-100 dark:hover:bg-slate-700"><Settings className="w-4 h-4"/></button>
                <button onClick={onDelete} className="p-1 text-gray-400 hover:text-rose-500 rounded hover:bg-gray-100 dark:hover:bg-slate-700"><XIcon className="w-4 h-4"/></button>
            </div>
        </div>

        {/* Contact Info */}
        <div className="text-sm text-gray-600 dark:text-slate-400 space-y-1.5 bg-gray-50 dark:bg-slate-700 p-2.5 rounded-lg border border-gray-100 dark:border-slate-600">
            {s.email && <div className="flex items-center gap-2 truncate"><Mail className="w-3.5 h-3.5 text-gray-400"/> {s.email}</div>}
            {s.phone && <div className="flex items-center gap-2 truncate"><Phone className="w-3.5 h-3.5 text-gray-400"/> {s.phone}</div>}
            
            {/* Socials */}
            {s.instagram && <div className="flex items-center gap-2 truncate"><Instagram className="w-3.5 h-3.5 text-pink-500"/> {s.instagram}</div>}
            {s.facebook && <div className="flex items-center gap-2 truncate"><Facebook className="w-3.5 h-3.5 text-blue-600"/> {s.facebook}</div>}
            {s.whatsapp && <div className="flex items-center gap-2 truncate"><MessageCircle className="w-3.5 h-3.5 text-green-500"/> {s.whatsapp}</div>}

            {!s.email && !s.phone && !s.instagram && !s.facebook && !s.whatsapp && <span className="text-xs text-gray-400 italic">No contact info</span>}
        </div>

        {/* Custom Info Toggle */}
        {s.customInfo && (
            <>
                <button 
                    onClick={() => setIsExpanded(!isExpanded)}
                    className="w-full py-2 flex items-center justify-center text-xs font-bold text-gray-400 hover:text-indigo-600 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg transition-all mt-auto"
                >
                    {isExpanded ? (
                        <><ChevronUp className="w-4 h-4 mr-1" /> Hide Details</>
                    ) : (
                        <><ChevronDown className="w-4 h-4 mr-1" /> View Details</>
                    )}
                </button>

                {isExpanded && (
                    <div className="animate-in fade-in slide-in-from-top-2 duration-200">
                        <div className="text-xs bg-orange-50 dark:bg-orange-900/20 p-2.5 rounded border border-orange-100 dark:border-orange-800 text-gray-700 dark:text-slate-300 italic leading-relaxed">
                            <span className="font-bold text-orange-800 dark:text-orange-300 not-italic block mb-1">Additional Info:</span>
                            {s.customInfo}
                        </div>
                    </div>
                )}
            </>
        )}
    </Card>
  );
};

const StaffListModule = ({ staff, onAddStaff, onUpdateStaff, onDeleteStaff }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({ name: '', role: 'Trainer', email: '', phone: '', dob: '', instagram: '', facebook: '', whatsapp: '', customInfo: '' });
    const [editingId, setEditingId] = useState(null);

    // --- Filtering & Sorting State ---
    const [activeFilter, setActiveFilter] = useState('All');
    const [sortBy, setSortBy] = useState('name');

    const handleSubmit = (e) => {
        e.preventDefault();
        if(editingId) {
            onUpdateStaff(editingId, formData);
        } else {
            onAddStaff({ ...formData, createdAt: new Date().toISOString() });
        }
        setIsModalOpen(false);
    };

    // --- Logic ---
    const uniqueRoles = useMemo(() => {
        const roles = staff.map(s => s.role).filter(Boolean);
        return ['All', ...new Set(roles)].sort();
    }, [staff]);

    const processedStaff = useMemo(() => {
        let result = [...staff];
        
        // Filter
        if (activeFilter !== 'All') {
            result = result.filter(s => s.role === activeFilter);
        }

        // Sort
        result.sort((a, b) => {
            if (sortBy === 'name') return a.name.localeCompare(b.name);
            if (sortBy === 'newest') {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return dateB - dateA;
            }
            if (sortBy === 'oldest') {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return dateA - dateB;
            }
            return 0;
        });
        return result;
    }, [staff, activeFilter, sortBy]);

    return (
        <div className="space-y-6">
             <div className="flex flex-col gap-4">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Staff</h2>
                    <Button onClick={() => { setEditingId(null); setFormData({name: '', role: 'Trainer', email: '', phone: '', dob: '', instagram: '', facebook: '', whatsapp: '', customInfo: ''}); setIsModalOpen(true); }} icon={Plus}>Add Staff</Button>
                </div>

                {/* Controls Row */}
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white dark:bg-slate-800 p-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm">
                    {/* Role Filter Pills */}
                    <div className="flex-1 overflow-x-auto no-scrollbar w-full">
                        <div className="flex space-x-2 px-1">
                            {uniqueRoles.map(role => (
                                <button
                                    key={role}
                                    onClick={() => setActiveFilter(role)}
                                    className={`px-3 py-1.5 text-xs font-medium rounded-lg whitespace-nowrap transition-colors border ${
                                        activeFilter === role 
                                        ? 'bg-indigo-600 text-white border-indigo-600 shadow-sm' 
                                        : 'bg-white dark:bg-slate-700 text-gray-600 dark:text-slate-300 border-gray-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-600'
                                    }`}
                                >
                                    {role}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Sort Dropdown */}
                    <div className="flex items-center space-x-2 pl-2 border-l border-gray-200 dark:border-slate-700 flex-shrink-0">
                        <span className="text-xs font-bold text-gray-400 uppercase">Sort:</span>
                        <select 
                            value={sortBy} 
                            onChange={(e) => setSortBy(e.target.value)}
                            className="text-sm border-none bg-transparent font-medium text-gray-700 dark:text-white focus:ring-0 cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400"
                        >
                            <option className="dark:bg-slate-800" value="name">Alphabetical (A-Z)</option>
                            <option className="dark:bg-slate-800" value="newest">Newest First</option>
                            <option className="dark:bg-slate-800" value="oldest">Oldest First</option>
                        </select>
                    </div>
                </div>
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 {processedStaff.map(s => (
                     <StaffCard 
                        key={s.id} 
                        s={s} 
                        onEdit={() => { setEditingId(s.id); setFormData(s); setIsModalOpen(true); }}
                        onDelete={() => onDeleteStaff(s.id)}
                     />
                 ))}
                 {processedStaff.length === 0 && <div className="col-span-full text-center py-12 text-gray-500 bg-gray-50 dark:bg-slate-700 rounded-lg border border-dashed border-gray-300 dark:border-slate-600">No staff members found matching this filter.</div>}
             </div>
             <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingId ? "Edit Staff" : "New Staff"}>
                 <form onSubmit={handleSubmit}>
                     <Input label="Name" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} required />
                     <Select label="Role" value={formData.role || 'Trainer'} onChange={e => setFormData({...formData, role: e.target.value})}><option>Trainer</option><option>Stable Hand</option><option>Manager</option><option>Vet</option></Select>
                     <div className="grid grid-cols-2 gap-4">
                        <Input label="Email" type="email" value={formData.email || ''} onChange={e => setFormData({...formData, email: e.target.value})} />
                        <Input label="Phone" type="tel" value={formData.phone || ''} onChange={e => setFormData({...formData, phone: e.target.value})} />
                     </div>
                     <Input label="Date of Birth" type="date" value={formData.dob || ''} onChange={e => setFormData({...formData, dob: e.target.value})} />
                     
                     <div className="grid grid-cols-3 gap-3">
                        <Input label="Instagram" placeholder="@..." value={formData.instagram || ''} onChange={e=>setFormData({...formData, instagram:e.target.value})} />
                        <Input label="Facebook" placeholder="Name/URL" value={formData.facebook || ''} onChange={e=>setFormData({...formData, facebook:e.target.value})} />
                        <Input label="WhatsApp" placeholder="+1..." value={formData.whatsapp || ''} onChange={e=>setFormData({...formData, whatsapp:e.target.value})} />
                     </div>

                     <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Custom Information</label>
                        <textarea
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            rows="2"
                            placeholder="e.g. Certifications, Emergency Contact, Allergies..."
                            value={formData.customInfo || ''}
                            onChange={e => setFormData({...formData, customInfo: e.target.value})}
                        />
                     </div>
                     <div className="flex justify-end pt-4"><Button type="submit">Save</Button></div>
                 </form>
             </Modal>
        </div>
    );
};

// Custom Switch Component
const SettingsSwitch = ({ label, desc, checked, onChange }) => (
    <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700 rounded-lg border border-gray-100 dark:border-slate-600">
        <div><p className="text-sm font-medium text-gray-900 dark:text-white">{label}</p><p className="text-xs text-gray-500 dark:text-slate-400">{desc}</p></div>
        <button type="button" onClick={() => onChange(!checked)} className={`${checked ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-slate-600'} relative inline-flex h-6 w-11 items-center rounded-full transition-colors`}>
            <span className={`${checked ? 'translate-x-6' : 'translate-x-1'} inline-block h-4 w-4 transform rounded-full bg-white transition-transform`} />
        </button>
    </div>
);

const SettingsModule = ({ settings, onUpdateSettings }) => {
  const [formData, setFormData] = useState({ ...settings });

  useEffect(() => {
      setFormData({ ...settings });
  }, [settings]);

  const handleSubmit = (e) => { e.preventDefault(); onUpdateSettings(formData); };
  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="flex items-center space-x-3 mb-6"><div className="p-3 bg-gray-100 dark:bg-slate-700 rounded-lg text-gray-600 dark:text-slate-300"><Shield className="w-6 h-6" /></div><div><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Administrator Block</h2><p className="text-sm text-gray-500 dark:text-slate-400">Configure system-wide settings and user role permissions</p></div></div>
      <Card className="p-6">
        <form onSubmit={handleSubmit} className="space-y-8">
            <div>
              <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">Stable Information</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <Input label="Stable Name" value={formData.stableName} onChange={e=>setFormData({...formData, stableName:e.target.value})}/>
                
                <Select label="Measurement Units" value={formData.measurementUnit || 'Metric'} onChange={e=>setFormData({...formData, measurementUnit:e.target.value})}>
                    <option value="Metric">Metric (Meters, cm, kg)</option>
                    <option value="Imperial">Imperial (Feet, Inches, lbs)</option>
                </Select>
                <Select label="Calendar Start Day" value={formData.calendarStartDay || 'Sunday'} onChange={e=>setFormData({...formData, calendarStartDay:e.target.value})}>
                    <option value="Sunday">Sunday (US/Default)</option>
                    <option value="Monday">Monday (EU/ISO)</option>
                </Select>
                <Select label="Date Format" value={formData.dateFormat || 'DD/MM/YYYY'} onChange={e=>setFormData({...formData, dateFormat:e.target.value})}>
                    <option value="DD/MM/YYYY">DD/MM/YYYY (EU)</option>
                    <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                </Select>
              </div>
            </div>
           
            <div className="border-t border-gray-100 dark:border-slate-700 pt-6">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">Role Permissions</h3>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-3"><h4 className="font-bold text-gray-900 dark:text-white">Students & Parents</h4>
                        <SettingsSwitch label="Client Booking" desc="Allow students & parents to book lessons" checked={formData.studentSelfBooking} onChange={v=>setFormData({...formData, studentSelfBooking:v})} />
                        <SettingsSwitch label="View Schedule" desc="See full barn schedule" checked={formData.studentViewBarnSchedule} onChange={v=>setFormData({...formData, studentViewBarnSchedule:v})} />
                        <SettingsSwitch label="View Horses" desc="See horse profiles" checked={formData.studentViewHorseProfiles} onChange={v=>setFormData({...formData, studentViewHorseProfiles:v})} />
                    </div>
                    <div className="space-y-3"><h4 className="font-bold text-gray-900 dark:text-white">Staff</h4>
                        <SettingsSwitch label="Horses" desc="Manage horses & feed" checked={formData.staffEditMedicalFeed} onChange={v=>setFormData({...formData, staffEditMedicalFeed:v})} />
                        <SettingsSwitch label="Students" desc="Manage students" checked={formData.staffViewStudents} onChange={v=>setFormData({...formData, staffViewStudents:v})} />
                        <SettingsSwitch label="Parents" desc="Manage parents" checked={formData.staffViewParents} onChange={v=>setFormData({...formData, staffViewParents:v})} />
                        <SettingsSwitch label="Schedule" desc="Manage lessons" checked={formData.staffScheduleManagement} onChange={v=>setFormData({...formData, staffScheduleManagement:v})} />
                        <SettingsSwitch label="Inventory" desc="Update stock" checked={formData.staffInventoryControl} onChange={v=>setFormData({...formData, staffInventoryControl:v})} />
                        <SettingsSwitch label="Tasks" desc="Manage tasks" checked={formData.staffViewTasks} onChange={v=>setFormData({...formData, staffViewTasks:v})} />
                        <SettingsSwitch label="Manage Staff" desc="Add/Edit staff members" checked={formData.staffViewStaff} onChange={v=>setFormData({...formData, staffViewStaff:v})} />
                        <SettingsSwitch label="Announcements" desc="Post news" checked={formData.staffManageAnnouncements} onChange={v=>setFormData({...formData, staffManageAnnouncements:v})} />
                    </div>
                </div>
            </div>
            <div className="flex justify-end pt-6"><Button type="submit" icon={Save}>Save Configuration</Button></div>
        </form>
      </Card>
    </div>
  );
};

// --- Message Center Module ---
const MessageCenterModule = ({ currentUser, messages, allUsers, onSendMessage, onDeleteMessage }) => {
    const [selectedPartner, setSelectedPartner] = useState(null);
    const [isComposeOpen, setIsComposeOpen] = useState(false);
    const [composeData, setComposeData] = useState({ to: '', subject: '', content: '' });
    const [replyText, setReplyText] = useState('');
    const scrollRef = useRef(null);

    // Group messages by conversation partner
    const conversations = useMemo(() => {
        const groups = {};
        messages.forEach(msg => {
            const isFromMe = msg.from === currentUser.name;
            const isToMe = msg.to === currentUser.name || (currentUser.role && msg.to === currentUser.role);
            
            if (!isFromMe && !isToMe) return;

            // The partner is the other person in the conversation
            const partner = isFromMe ? msg.to : msg.from;
            
            if (!groups[partner]) groups[partner] = [];
            groups[partner].push(msg);
        });
        return groups;
    }, [messages, currentUser]);

    // Get partners sorted by most recent message
    const sortedPartners = useMemo(() => {
        return Object.keys(conversations).sort((a, b) => {
            const lastA = conversations[a].reduce((latest, m) => new Date(m.date) > new Date(latest.date) ? m : latest, conversations[a][0]);
            const lastB = conversations[b].reduce((latest, m) => new Date(m.date) > new Date(latest.date) ? m : latest, conversations[b][0]);
            return new Date(lastB.date) - new Date(lastA.date);
        });
    }, [conversations]);

    // Auto-scroll to bottom of chat
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
    }, [selectedPartner, conversations]);

    const handleSend = (e) => {
        e.preventDefault();
        onSendMessage({ ...composeData, from: currentUser.name, date: new Date().toISOString(), read: false });
        setIsComposeOpen(false); 
        setComposeData({ to: '', subject: '', content: '' });
        setSelectedPartner(composeData.to);
    };

    const handleReply = (e) => {
        e.preventDefault();
        if (!replyText.trim() || !selectedPartner) return;
        
        onSendMessage({ 
            to: selectedPartner, 
            from: currentUser.name, 
            subject: 'Message', 
            content: replyText, 
            date: new Date().toISOString(), 
            read: false 
        });
        setReplyText('');
    };

    const activeMessages = selectedPartner ? [...(conversations[selectedPartner] || [])].sort((a,b) => new Date(a.date) - new Date(b.date)) : [];

    return (
        <div className="h-[calc(100vh-140px)] flex flex-col">
            <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-gray-900 dark:text-white">Message Center</h2><Button onClick={() => setIsComposeOpen(true)} icon={Edit2}>New Message</Button></div>
            <div className="flex-1 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden flex transition-colors duration-200">
                
                {/* Sidebar: Conversation List */}
                <div className="w-80 border-r border-gray-100 dark:border-slate-700 flex flex-col bg-gray-50 dark:bg-slate-900 transition-colors duration-200">
                    <div className="p-4 border-b border-gray-200 dark:border-slate-700 font-bold text-gray-700 dark:text-slate-300 bg-white dark:bg-slate-800">Chats</div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        {sortedPartners.map(partner => {
                            const partnerMsgs = conversations[partner];
                            const lastMsg = [...partnerMsgs].sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                            const isUnread = lastMsg.to === currentUser.name && !lastMsg.read;
                            
                            return (
                                <div 
                                    key={partner} 
                                    onClick={() => setSelectedPartner(partner)}
                                    className={`p-4 border-b border-gray-100 dark:border-slate-700 cursor-pointer hover:bg-white dark:hover:bg-slate-800 transition-colors ${selectedPartner === partner ? 'bg-white dark:bg-slate-800 border-l-4 border-l-indigo-600 shadow-sm' : ''}`}
                                >
                                    <div className="flex justify-between items-center mb-1">
                                        <span className={`text-sm truncate w-32 dark:text-slate-200 ${isUnread ? 'font-black text-gray-900' : 'font-bold text-gray-700'}`}>{partner}</span>
                                        <span className="text-[10px] text-gray-400 whitespace-nowrap">{new Date(lastMsg.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
                                    </div>
                                    <p className={`text-xs truncate ${isUnread ? 'font-bold text-gray-800 dark:text-slate-100' : 'text-gray-500 dark:text-slate-400'}`}>
                                        {lastMsg.from === currentUser.name && <span className="text-indigo-600 dark:text-indigo-400 mr-1">You:</span>}
                                        {lastMsg.content}
                                    </p>
                                </div>
                            );
                        })}
                        {sortedPartners.length === 0 && <div className="p-8 text-center text-gray-400 text-sm italic">No conversations yet.</div>}
                    </div>
                </div>

                {/* Main Content: Chat Window */}
                <div className="flex-1 flex flex-col bg-slate-50 dark:bg-slate-900 relative transition-colors duration-200">
                    {selectedPartner ? (
                        <>
                            {/* Chat Header */}
                            <div className="p-4 border-b border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex justify-between items-center shadow-sm z-10">
                                <div className="flex items-center space-x-3">
                                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-sm">
                                        {selectedPartner[0]}
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-gray-900 dark:text-white leading-tight">{selectedPartner}</h3>
                                        <span className="text-xs text-green-500 font-medium flex items-center"><span className="w-1.5 h-1.5 bg-green-500 rounded-full mr-1"></span> Active</span>
                                    </div>
                                </div>
                            </div>

                            {/* Messages Area */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                                {activeMessages.map((msg) => {
                                    const isMe = msg.from === currentUser.name;
                                    return (
                                        <div key={msg.id} className={`flex w-full ${isMe ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[70%] relative group`}>
                                                <div className={`p-3.5 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white dark:bg-slate-700 text-gray-800 dark:text-slate-100 border border-gray-100 dark:border-slate-600 rounded-bl-none'}`}>
                                                    <p className="whitespace-pre-wrap leading-relaxed">{msg.content}</p>
                                                </div>
                                                <div className={`flex items-center mt-1 text-[10px] text-gray-400 ${isMe ? 'justify-end' : 'justify-start'}`}>
                                                    <span>{new Date(msg.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                                    {!isMe && <button onClick={() => onDeleteMessage(msg.id)} className="ml-2 text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 className="w-3 h-3" /></button>}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {/* Input Area */}
                            <div className="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 transition-colors duration-200">
                                <form onSubmit={handleReply} className="flex items-center gap-2">
                                    <input 
                                        className="flex-1 px-4 py-3 border border-gray-200 dark:border-slate-600 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-white transition-all shadow-inner"
                                        placeholder="Type a message..."
                                        value={replyText}
                                        onChange={e => setReplyText(e.target.value)}
                                        autoFocus
                                    />
                                    <button 
                                        type="submit" 
                                        disabled={!replyText.trim()} 
                                        className="p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95 shadow-md"
                                    >
                                        <Send className="w-5 h-5 ml-0.5" />
                                    </button>
                                </form>
                            </div>
                        </>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center text-gray-300 dark:text-slate-600">
                            <div className="w-20 h-20 bg-gray-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4">
                                <MessageSquare className="w-10 h-10 text-gray-300 dark:text-slate-600" />
                            </div>
                            <p className="font-medium text-gray-400 dark:text-slate-500">Select a conversation to start chatting</p>
                        </div>
                    )}
                </div>
            </div>
            
            <Modal isOpen={isComposeOpen} onClose={() => setIsComposeOpen(false)} title="New Message">
                <form onSubmit={handleSend}>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">To</label>
                        <select 
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white"
                            value={composeData.to} 
                            onChange={e => setComposeData({...composeData, to: e.target.value})} 
                            required
                        >
                            <option value="">Select Recipient...</option>
                            {allUsers.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                        </select>
                    </div>
                    {/* Subject hidden for chat-style feel but kept in state if needed for consistency */}
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Message</label>
                        <textarea 
                            className="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 text-gray-900 dark:text-white" 
                            rows="5" 
                            value={composeData.content} 
                            onChange={e => setComposeData({...composeData, content: e.target.value})} 
                            required 
                        />
                    </div>
                    <div className="flex justify-end pt-2"><Button type="submit" icon={Send}>Send</Button></div>
                </form>
            </Modal>
        </div>
    );
};

// --- Main App ---

const App = () => {
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('dashboard');
  
  // Data States
  const [horses, setHorses] = useState([]);
  const [lessons, setLessons] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [students, setStudents] = useState([]);
  const [parents, setParents] = useState([]);
  const [staff, setStaff] = useState([]);
  const [inventory, setInventory] = useState([]);
  const [messages, setMessages] = useState([]); // Add messages state
  const [announcements, setAnnouncements] = useState([]); // Add announcements state
  const [showSeedModal, setShowSeedModal] = useState(false);
 
  // Theme State
  const [darkMode, setDarkMode] = useState(false);

  // Initialize theme based on system preference
  useEffect(() => {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      setDarkMode(true);
    }
  }, []);

  // Update HTML class for Tailwind Dark Mode
  useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [darkMode]);

  const toggleTheme = () => setDarkMode(!darkMode);

  // Settings with defaults - CRITICAL for permissions
  const [settings, setSettings] = useState({
    stableName: 'StableOS',
    measurementUnit: 'Metric',
    calendarStartDay: 'Monday',
    dateFormat: 'DD/MM/YYYY',
    studentSelfBooking: true,
    studentViewBarnSchedule: false,
    studentViewHorseProfiles: true,
    staffEditMedicalFeed: true,
    staffViewStudents: true,
    staffViewParents: true,
    staffScheduleManagement: true,
    staffInventoryControl: true,
    staffViewTasks: true,
    staffViewStaff: false,
    staffManageAnnouncements: false
  });

  // --- Auth & Data Sync ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
        if (u) {
            // Check if we have a specific role saved, else default to Admin for demo
            setUser({ uid: u.uid, email: u.email, role: 'Administrator', name: 'Admin User' });
        } else {
            setUser(null);
        }
        setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Data Listeners
  useEffect(() => {
    if (!user) return;

    // Collections
    const unsubHorses = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'horses'), 
        (snap) => setHorses(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Horses sync error", err));

    const unsubLessons = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'lessons'), 
        (snap) => setLessons(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Lessons sync error", err));

    const unsubTasks = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), 
        (snap) => setTasks(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Tasks sync error", err));

    const unsubStudents = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), 
        (snap) => setStudents(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Students sync error", err));

    const unsubParents = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'parents'), 
        (snap) => setParents(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Parents sync error", err));

    const unsubStaff = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), 
        (snap) => setStaff(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Staff sync error", err));

    const unsubInventory = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), 
        (snap) => setInventory(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Inventory sync error", err));
    
    const unsubMessages = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), 
        (snap) => setMessages(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Messages sync error", err));

    const unsubAnnouncements = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'announcements'), 
        (snap) => setAnnouncements(snap.docs.map(d => ({id: d.id, ...d.data()}))), 
        (err) => console.error("Announcements sync error", err));

    return () => {
        unsubHorses(); unsubLessons(); unsubTasks(); unsubStudents(); 
        unsubParents(); unsubStaff(); unsubInventory(); unsubMessages(); unsubAnnouncements();
    };
  }, [user]);

  // --- Handlers ---
  const handleAdd = (col, data) => addDoc(collection(db, 'artifacts', appId, 'public', 'data', col), data);
  const handleUpdate = (col, id, data) => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), data);
  const handleDelete = (col, id) => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));

  // Specialized Handlers
  const executeSeedData = async () => {
    // Helper to generate dynamic dates relative to today
    const getRelDate = (days) => {
        const d = new Date();
        d.setDate(d.getDate() + days);
        return d.toISOString().split('T')[0];
    };

    setShowSeedModal(false);

    try {
        // 1. Horses with full details
        await handleAdd('horses', { 
            name: 'Thunder', 
            stall: 'A1', 
            status: 'Active', 
            feed: '1 scoop Grain, 2 flakes Hay (AM/PM)', 
            skillLevel: 'Beginner',
            dob: '2015-05-12',
            gender: 'Gelding',
            breed: 'Quarter Horse',
            temperament: 'Calm',
            height: '15.2hh',
            maxDailyLessons: 2,
            notes: 'Great for beginners. Bombproof on trails.',
            medicalRecords: [
                { date: getRelDate(5), type: 'Farrier', notes: 'Routine shoeing cycle.' },
                { date: getRelDate(14), type: 'Vaccination', notes: 'Annual Flu/Tet booster due.' },
                { date: getRelDate(30), type: 'Dentist', notes: 'Routine dental checkup scheduled.' },
                { date: getRelDate(-10), type: 'Physio', notes: 'Massage for tight back muscles. Recommended 2 days light work.' },
                { date: getRelDate(-42), type: 'Farrier', notes: 'New shoes (fronts only). Hoof wall quality improved.' },
                { date: getRelDate(-120), type: 'Vet', notes: 'Minor colic episode. Treated with Banamine, resolved same day.' },
                { date: getRelDate(-180), type: 'Vaccination', notes: 'EHV-1/4 Booster administered.' },
                { date: getRelDate(-365), type: 'Dentist', notes: 'Teeth floated. Removed small wolf tooth.' }
            ],
            createdAt: new Date().toISOString()
        });

        await handleAdd('horses', { 
            name: 'Spirit', 
            stall: 'A2', 
            status: 'Active', 
            feed: '2 scoops Performance Mix, 3 flakes Hay', 
            skillLevel: 'Advanced',
            dob: '2018-03-20',
            gender: 'Stallion',
            breed: 'Andalusian',
            temperament: 'Spirited',
            height: '16.1hh',
            maxDailyLessons: 1,
            notes: 'Needs an experienced rider. Very responsive to leg aids.',
            medicalRecords: [
                { date: getRelDate(20), type: 'Vet', notes: 'Pre-season competition wellness exam.' },
                { date: getRelDate(-60), type: 'Farrier', notes: 'Trim and balance. No shoes needed.' }
            ],
            createdAt: new Date().toISOString()
        });

        await handleAdd('horses', { 
            name: 'Bella', 
            stall: 'P1', 
            status: 'Active', 
            feed: 'Handful of chaff, restricted grazing', 
            skillLevel: 'Beginner',
            dob: '2010-08-14',
            gender: 'Mare',
            breed: 'Pony',
            temperament: 'Cheeky',
            height: '13.2hh',
            maxDailyLessons: 3,
            notes: 'Loves treats. Can be lazy in the arena.',
            medicalRecords: [],
            createdAt: new Date().toISOString()
        });
        
        // 2. Parents
        const parentRef = await handleAdd('parents', { 
            name: 'Martha Kent', 
            email: 'martha@example.com', 
            phone: '+1 (555) 019-2834',
            dob: '1980-05-15',
            createdAt: new Date().toISOString()
        });
        
        // 3. Students (Adult & Junior)
        await handleAdd('students', { 
            name: 'Sarah Connor', 
            type: 'Adult', 
            email: 'sarah@example.com', 
            phone: '+1 (555) 987-6543',
            dob: '1995-08-29',
            address: '123 Tech Blvd, Cyberdyne City',
            instagram: '@sarah_rides',
            facebook: 'Sarah Connor Equestrian',
            whatsapp: '+1 555 987 6543',
            milestone: 'Jumping 80cm courses',
            parentId: '',
            skills: [
                { name: 'Walk', status: 'Mastered' },
                { name: 'Trot', status: 'Mastered' },
                { name: 'Canter', status: 'Learning' }
            ],
            achievements: ['First Canter üéâ', 'Completed 10 Lessons üèÖ'],
            development: [
                { date: new Date('2023-10-01').toISOString(), text: 'Great balance in the stirrups today.' },
                { date: new Date('2023-09-15').toISOString(), text: 'Struggled with diagonals, practice at home.' }
            ],
            createdAt: new Date().toISOString()
        });

        await handleAdd('students', { 
            name: 'Clark Kent', 
            type: 'Junior', 
            email: '', 
            parentId: parentRef.id,
            phone: '', 
            dob: '2012-02-29',
            address: 'Smallville Farm',
            instagram: '',
            facebook: '',
            whatsapp: '',
            milestone: 'Posting Trot',
            skills: [
                { name: 'Leading', status: 'Mastered' },
                { name: 'Mounting', status: 'Mastered' },
                { name: 'Steering', status: 'Learning' }
            ],
            achievements: ['Rode Without Lead Line üåü'],
            development: [
                { date: new Date('2023-11-20').toISOString(), text: 'Very gentle hands with the pony.' }
            ],
            createdAt: new Date().toISOString()
        });
        
        // 4. Staff
        await handleAdd('staff', { 
            name: 'John Dutton', 
            role: 'Manager', 
            email: 'john@yellowstone.com', 
            phone: '+1 (555) 111-2222',
            dob: '1975-04-12',
            instagram: '@jd_ranch',
            customInfo: 'Emergency Contact: Kayce (+1 555 333 4444). Certified First Aid.',
            createdAt: new Date().toISOString()
        });

        await handleAdd('staff', { 
            name: 'Rip Wheeler', 
            role: 'Trainer', 
            email: 'rip@yellowstone.com', 
            phone: '+1 (555) 666-7777',
            dob: '1982-09-28',
            whatsapp: '+1 555 666 7777',
            customInfo: 'Specializes in colt starting and behavioral issues.',
            createdAt: new Date().toISOString()
        });
        
        // 5. Lessons
        const today = new Date();
        const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);

        await handleAdd('lessons', { 
            title: 'Jumping Tech', 
            date: tomorrow.toISOString().split('T')[0], 
            time: '14:00',
            type: 'Private', 
            instructor: 'Rip Wheeler', 
            location: 'Outdoor Arena', 
            student: 'Sarah Connor',
            horse: 'Spirit',
            focus: 'Verticals and Oxers',
            equipment: 'Body protector required',
            status: 'Scheduled',
            comment: 'Prepare the cavaletti setup.'
        });

        await handleAdd('lessons', { 
            title: 'Beginner Group', 
            date: yesterday.toISOString().split('T')[0], 
            time: '10:00',
            type: 'Group', 
            instructor: 'Rip Wheeler', 
            location: 'Indoor Arena', 
            attendees: [
                { student: 'Clark Kent', horse: 'Bella' },
                { student: 'Sarah Connor', horse: 'Thunder' }
            ],
            focus: 'Steering and transitions',
            equipment: '',
            status: 'Scheduled',
            outcomes: {
                'Clark Kent': { achievement: 'Walk-Trot Transition', note: 'Did great keeping heels down.' }
            }
        });
        
        // 6. Inventory
        await handleAdd('inventory', { name: 'Alfalfa Hay', category: 'Feed', quantity: 20, unit: 'bales', reorderPoint: 50 });
        await handleAdd('inventory', { name: 'Sweet Feed', category: 'Feed', quantity: 4, unit: 'bags', reorderPoint: 10 });
        await handleAdd('inventory', { name: 'Shavings', category: 'Bedding', quantity: 45, unit: 'bags', reorderPoint: 20 });
        await handleAdd('inventory', { name: 'Hoof Oil', category: 'Equipment', quantity: 2, unit: 'cans', reorderPoint: 3 });
        await handleAdd('inventory', { name: 'Bute', category: 'Medical', quantity: 5, unit: 'sachets', reorderPoint: 10 });
        
        // 7. Tasks
        await handleAdd('tasks', { 
            title: 'Fix Pasture Fence', 
            description: 'Post 4 in the north paddock is loose. Needs urgent repair before turnout.', 
            priority: 'High', 
            status: 'Pending', 
            assignedTo: 'Rip Wheeler',
            dueDate: tomorrow.toISOString().split('T')[0]
        });

        await handleAdd('tasks', { 
            title: 'Order Supplements', 
            description: 'Check stock of joint supplements and reorder if low.', 
            priority: 'Medium', 
            status: 'In Progress', 
            assignedTo: 'John Dutton',
            dueDate: today.toISOString().split('T')[0]
        });
        
        // 8. Settings
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), settings);
        
        alert("Demo data loaded successfully!");
    } catch (e) {
        console.error("Error seeding data:", e);
        alert("Error adding demo data: " + e.message);
    }
  };

  // --- Derived State for Layout ---
  const navItems = [
      { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
      { id: 'schedule', label: 'Schedule', icon: Calendar },
      { id: 'horses', label: 'Horses', icon: Horse },
      { id: 'students', label: 'Students', icon: GraduationCap },
      { id: 'parents', label: 'Parents', icon: Users },
      { id: 'staff', label: 'Staff', icon: UserCog },
      { id: 'tasks', label: 'Tasks', icon: ClipboardList },
      { id: 'inventory', label: 'Inventory', icon: Package },
      { id: 'messages', label: 'Messages', icon: MessageSquare },
      { id: 'announcements', label: 'Announcements', icon: Megaphone },
      { id: 'settings', label: 'Settings', icon: Settings },
  ];

  const renderContent = () => {
      switch(activeTab) {
          case 'dashboard': return <Dashboard horses={horses} lessons={lessons} tasks={tasks} inventory={inventory} settings={settings} seedData={() => setShowSeedModal(true)} onToggleTask={task => handleUpdate('tasks', task.id, {status: task.status === 'Completed' ? 'Pending' : 'Completed'})} announcements={announcements} />;
          case 'schedule': return <ScheduleModule lessons={lessons} horses={horses} students={students} staff={staff} settings={settings} onAddLesson={d => handleAdd('lessons', d)} onUpdateLesson={(id, d) => handleUpdate('lessons', id, d)} onDeleteLesson={id => handleDelete('lessons', id)} onUpdateStudent={(id, d) => handleUpdate('students', id, d)} />;
          case 'horses': return <HorsesModule horses={horses} onAddHorse={d => handleAdd('horses', d)} onUpdateHorse={(id, d) => handleUpdate('horses', id, d)} onDeleteHorse={id => handleDelete('horses', id)} />;
          case 'students': return <StudentsModule students={students} parents={parents} lessons={lessons} onAddStudent={d => handleAdd('students', d)} onUpdateStudent={(id, d) => handleUpdate('students', id, d)} onDeleteStudent={id => handleDelete('students', id)} />;
          case 'parents': return <ParentsModule parents={parents} students={students} onAddParent={d => handleAdd('parents', d)} onUpdateParent={(id, d) => handleUpdate('parents', id, d)} onDeleteParent={id => handleDelete('parents', id)} />;
          case 'staff': return <StaffListModule staff={staff} onAddStaff={d => handleAdd('staff', d)} onUpdateStaff={(id, d) => handleUpdate('staff', id, d)} onDeleteStaff={id => handleDelete('staff', id)} />;
          case 'tasks': return <TasksModule tasks={tasks} staff={staff} onAddTask={d => handleAdd('tasks', d)} onUpdateTask={(id, d) => handleUpdate('tasks', id, d)} onDeleteTask={id => handleDelete('tasks', id)} />;
          case 'inventory': return <InventoryModule inventory={inventory} onAddItem={d => handleAdd('inventory', d)} onUpdateItem={(id, d) => handleUpdate('inventory', id, d)} onDeleteItem={id => handleDelete('inventory', id)} />;
          case 'messages': return <MessageCenterModule currentUser={user} messages={messages} allUsers={[...students, ...parents, ...staff]} onSendMessage={d => handleAdd('messages', d)} onDeleteMessage={id => handleDelete('messages', id)} />;
          case 'announcements': return <AnnouncementsModule announcements={announcements} onAdd={d => handleAdd('announcements', d)} onDelete={id => handleDelete('announcements', id)} currentUser={user} />;
          case 'settings': return <SettingsModule settings={settings} onUpdateSettings={s => setSettings(s)} />;
          default: return <Dashboard horses={horses} lessons={lessons} tasks={tasks} inventory={inventory} settings={settings} announcements={announcements} />;
      }
  };

  // --- Views for other roles ---
  const [demoRole, setDemoRole] = useState('Administrator');
  const [demoProfile, setDemoProfile] = useState(null);

  const handleSwitchRole = (role, profile) => {
      setDemoRole(role);
      setDemoProfile(profile);
      setActiveTab(role === 'Administrator' ? 'dashboard' : 'home');
  };

  if (authLoading) return <div className="h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 text-slate-400">Loading StableOS...</div>;

  if (demoRole === 'Student' && demoProfile) {
      // Dynamic Navigation for Students based on Settings
      const studentNav = [
          { id: 'home', label: 'My Stable', icon: Horse },
          ...(settings.studentViewBarnSchedule ? [{ id: 'schedule', label: 'Barn Schedule', icon: Calendar }] : []),
          ...(settings.studentViewHorseProfiles ? [{ id: 'horses', label: 'Horses', icon: Shield }] : []),
          { id: 'messages', label: 'Messages', icon: MessageSquare }
      ];

      return (
        <AppLayout 
            title={settings.stableName} 
            navItems={studentNav} 
            activeTab={activeTab === 'dashboard' ? 'home' : activeTab} 
            onTabChange={setActiveTab}
            darkMode={darkMode}
            toggleTheme={toggleTheme}
            bottomContent={<SidebarFooter role={demoRole} currentUserProfile={demoProfile} students={students} parents={parents} staff={staff} onSwitchRole={handleSwitchRole} onLogout={() => signOut(auth)} />}
        >
            {activeTab === 'messages' ? (
                <MessageCenterModule currentUser={{name: demoProfile.name, role: 'Student'}} messages={messages} allUsers={staff} onSendMessage={d => handleAdd('messages', d)} onDeleteMessage={id => handleDelete('messages', id)} />
            ) : activeTab === 'schedule' ? (
                <ScheduleModule lessons={lessons} horses={horses} students={students} staff={staff} settings={settings} readOnly={true} onAddLesson={() => {}} onUpdateLesson={() => {}} onDeleteLesson={() => {}} />
            ) : activeTab === 'horses' ? (
                <HorsesModule horses={horses} readOnly={true} />
            ) : (
                <StudentView student={demoProfile} lessons={lessons} horses={horses} settings={settings} announcements={announcements} onBookLesson={d => handleAdd('lessons', {...d, status: 'Pending'})} />
            )}
        </AppLayout>
      );
  }

  if (demoRole === 'Parent' && demoProfile) {
      // Dynamic Navigation for Parents based on Settings
      const parentNav = [
          { id: 'home', label: 'Family Portal', icon: Users },
          ...(settings.studentViewBarnSchedule ? [{ id: 'schedule', label: 'Barn Schedule', icon: Calendar }] : []),
          ...(settings.studentViewHorseProfiles ? [{ id: 'horses', label: 'Horses', icon: Shield }] : []),
          { id: 'messages', label: 'Messages', icon: MessageSquare }
      ];

      return (
        <AppLayout 
            title={settings.stableName} 
            navItems={parentNav} 
            activeTab={activeTab === 'dashboard' ? 'home' : activeTab} 
            onTabChange={setActiveTab}
            darkMode={darkMode}
            toggleTheme={toggleTheme}
            bottomContent={<SidebarFooter role={demoRole} currentUserProfile={demoProfile} students={students} parents={parents} staff={staff} onSwitchRole={handleSwitchRole} onLogout={() => signOut(auth)} />}
        >
             {activeTab === 'messages' ? (
                 <MessageCenterModule currentUser={{name: demoProfile.name, role: 'Parent'}} messages={messages} allUsers={[...students, ...parents, ...staff]} onSendMessage={d => handleAdd('messages', d)} onDeleteMessage={id => handleDelete('messages', id)} />
             ) : activeTab === 'schedule' ? (
                 <ScheduleModule lessons={lessons} horses={horses} students={students} staff={staff} settings={settings} readOnly={true} onAddLesson={() => {}} onUpdateLesson={() => {}} onDeleteLesson={() => {}} />
             ) : activeTab === 'horses' ? (
                 <HorsesModule horses={horses} readOnly={true} />
             ) : (
                 <ParentView parent={demoProfile} students={students} lessons={lessons} settings={settings} announcements={announcements} onBookLesson={d => handleAdd('lessons', {...d, status: 'Pending'})} />
             )}
        </AppLayout>
      );
  }

  if (demoRole === 'Staff' && demoProfile) {
      // Dynamic Navigation for Staff based on Settings
      const staffNav = [
          { id: 'home', label: 'Staff Dashboard', icon: LayoutDashboard },
          ...(settings.staffScheduleManagement ? [{ id: 'schedule', label: 'Schedule', icon: Calendar }] : []),
          { id: 'horses', label: 'Horses', icon: Horse },
          ...(settings.staffViewStudents ? [{ id: 'students', label: 'Students', icon: GraduationCap }] : []),
          ...(settings.staffViewParents ? [{ id: 'parents', label: 'Parents', icon: Users }] : []),
          ...(settings.staffViewStaff ? [{ id: 'staff', label: 'Staff', icon: UserCog }] : []),
          ...(settings.staffViewTasks ? [{ id: 'tasks', label: 'Tasks', icon: ClipboardList }] : []),
          ...(settings.staffInventoryControl ? [{ id: 'inventory', label: 'Inventory', icon: Package }] : []),
          ...(settings.staffManageAnnouncements ? [{ id: 'announcements', label: 'News', icon: Megaphone }] : []),
          { id: 'messages', label: 'Messages', icon: MessageSquare }
      ];

      return (
        <AppLayout 
            title={settings.stableName} 
            navItems={staffNav} 
            activeTab={activeTab === 'dashboard' ? 'home' : activeTab} 
            onTabChange={setActiveTab}
            darkMode={darkMode}
            toggleTheme={toggleTheme}
            bottomContent={<SidebarFooter role={demoRole} currentUserProfile={demoProfile} students={students} parents={parents} staff={staff} onSwitchRole={handleSwitchRole} onLogout={() => signOut(auth)} />}
        >
             {activeTab === 'horses' ? (
                 <HorsesModule horses={horses} readOnly={!settings.staffEditMedicalFeed} onUpdateHorse={(id, d) => handleUpdate('horses', id, d)} />
             ) : activeTab === 'schedule' ? (
                 <ScheduleModule lessons={lessons} horses={horses} students={students} staff={staff} settings={settings} onAddLesson={d => handleAdd('lessons', d)} onUpdateLesson={(id, d) => handleUpdate('lessons', id, d)} onDeleteLesson={id => handleDelete('lessons', id)} />
             ) : activeTab === 'students' ? (
                 <StudentsModule students={students} parents={parents} lessons={lessons} onAddStudent={d => handleAdd('students', d)} onUpdateStudent={(id, d) => handleUpdate('students', id, d)} onDeleteStudent={id => handleDelete('students', id)} />
             ) : activeTab === 'parents' ? (
                 <ParentsModule parents={parents} students={students} onAddParent={d => handleAdd('parents', d)} onUpdateParent={(id, d) => handleUpdate('parents', id, d)} onDeleteParent={id => handleDelete('parents', id)} />
             ) : activeTab === 'staff' ? (
                 <StaffListModule staff={staff} onAddStaff={d => handleAdd('staff', d)} onUpdateStaff={(id, d) => handleUpdate('staff', id, d)} onDeleteStaff={id => handleDelete('staff', id)} />
             ) : activeTab === 'tasks' ? (
                 <TasksModule tasks={tasks} staff={staff} onAddTask={d => handleAdd('tasks', d)} onUpdateTask={(id, d) => handleUpdate('tasks', id, d)} onDeleteTask={id => handleDelete('tasks', id)} />
             ) : activeTab === 'inventory' ? (
                 <InventoryModule inventory={inventory} onAddItem={d => handleAdd('inventory', d)} onUpdateItem={(id, d) => handleUpdate('inventory', id, d)} onDeleteItem={id => handleDelete('inventory', id)} />
             ) : activeTab === 'announcements' ? (
                 <AnnouncementsModule announcements={announcements} onAdd={d => handleAdd('announcements', d)} onDelete={id => handleDelete('announcements', id)} currentUser={{name: demoProfile.name, role: 'Staff'}} />
             ) : activeTab === 'messages' ? (
                 <MessageCenterModule currentUser={{name: demoProfile.name, role: 'Staff'}} messages={messages} allUsers={[...students, ...parents, ...staff]} onSendMessage={d => handleAdd('messages', d)} onDeleteMessage={id => handleDelete('messages', id)} />
             ) : (
                 <StaffView staffMember={demoProfile} tasks={tasks} horses={horses} lessons={lessons} inventory={inventory} settings={settings} announcements={announcements} onToggleTask={task => handleUpdate('tasks', task.id, {status: task.status === 'Completed' ? 'Pending' : 'Completed'})} onNavigate={setActiveTab} />
             )}
        </AppLayout>
      );
  }

  // Admin View
  return (
    <AppLayout 
        title={settings.stableName} 
        navItems={navItems} 
        activeTab={activeTab} 
        onTabChange={setActiveTab} 
        bottomContent={<SidebarFooter role="Administrator" currentUserProfile={user} students={students} parents={parents} staff={staff} onSwitchRole={handleSwitchRole} onLogout={() => signOut(auth)} />}
        darkMode={darkMode}
        toggleTheme={toggleTheme}
    >
        {renderContent()}

        {/* Seed Data Modal */}
        <Modal isOpen={showSeedModal} onClose={() => setShowSeedModal(false)} title="Load Demo Data?">
            <div className="space-y-4">
                <div className="bg-amber-50 dark:bg-amber-900/20 text-amber-800 dark:text-amber-200 p-4 rounded-lg flex items-start border border-amber-100 dark:border-amber-800">
                    <AlertTriangle className="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" />
                    <div>
                        <p className="font-bold">Confirmation Required</p>
                        <p className="text-sm mt-1">This will populate your database with sample horses, students, staff, and lessons. This is intended for empty accounts.</p>
                    </div>
                </div>
                <div className="flex justify-end gap-3">
                    <Button variant="secondary" onClick={() => setShowSeedModal(false)}>Cancel</Button>
                    <Button onClick={executeSeedData}>Yes, Load Data</Button>
                </div>
            </div>
        </Modal>
    </AppLayout>
  );
};

export default App;
